var t,e;t=this,e=function(t){const e={};let n,i,r,o=!1;const s={},a=.5*(Math.sqrt(3)-1),l=(3-Math.sqrt(3))/6,c=t=>0|Math.floor(t),u=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function f(t=Math.random){const e=function(t){const e=new Uint8Array(512);for(let t=0;t<256;t++)e[t]=t;for(let n=0;n<255;n++){const i=n+~~(t()*(256-n)),r=e[n];e[n]=e[i],e[i]=r}for(let t=256;t<512;t++)e[t]=e[t-256];return e}(t),n=new Float64Array(e).map((t=>u[t%12*2])),i=new Float64Array(e).map((t=>u[t%12*2+1]));return function(t,r){let o=0,s=0,u=0;const f=(t+r)*a,h=c(t+f),x=c(r+f),m=(h+x)*l,d=t-(h-m),p=r-(x-m);let v,y;d>p?(v=1,y=0):(v=0,y=1);const g=d-v+l,w=p-y+l,_=d-1+2*l,A=p-1+2*l,b=255&h,E=255&x;let M=.5-d*d-p*p;if(M>=0){const t=b+e[E];M*=M,o=M*M*(n[t]*d+i[t]*p)}let k=.5-g*g-w*w;if(k>=0){const t=b+v+e[E+y];k*=k,s=k*k*(n[t]*g+i[t]*w)}let F=.5-_*_-A*A;if(F>=0){const t=b+1+e[E+1];F*=F,u=F*F*(n[t]*_+i[t]*A)}return 70*(o+s+u)}}function h(t,e){let n=new x(t),i=()=>n.next();return i.double=()=>i()+11102230246251565e-32*(2097152*i()|0),i.int32=()=>4294967296*n.next()|0,i.quick=i,i}class x{constructor(t){null==t&&(t=+new Date);let e=4022871197;function n(t){t=String(t);for(let n=0;n<t.length;n++){e+=t.charCodeAt(n);let i=.02519603282416938*e;e=i>>>0,i-=e,i*=e,e=i>>>0,i-=e,e+=4294967296*i}return 2.3283064365386963e-10*(e>>>0)}this.c=1,this.s0=n(" "),this.s1=n(" "),this.s2=n(" "),this.s0-=n(t),this.s0<0&&(this.s0+=1),this.s1-=n(t),this.s1<0&&(this.s1+=1),this.s2-=n(t),this.s2<0&&(this.s2+=1)}next(){let{c:t,s0:e,s1:n,s2:i}=this,r=2091639*e+2.3283064365386963e-10*t;return this.s0=n,this.s1=i,this.s2=r-(this.c=0|r)}copy(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}}let m=h(Math.random()),d=h(Math.random());t.noise=f(d);const p=(t=0,e=1)=>t+m()*(e-t),v=(t,e)=>~~p(t,e);function y(t=0,e=1){const n=1-m(),i=m();return Math.sqrt(-2*Math.log(n))*b(360*i)*e+t}function g(t){let e=0;const n=[];for(const i in t)e+=t[i],n.push({key:i,cumulative:e});const i=m()*e;for(const t of n)if(i<t.cumulative)return isNaN(t.key)?t.key:parseInt(t.key)}function w(t,e,n,i,r,o=!1){let s=i+(t-e)/(n-e)*(r-i);return o?i<r?_(s,i,r):_(s,r,i):s}function _(t,e,n){return Math.max(Math.min(t,n),e)}function A(t){return(t%=360)<0?t+360:t}function b(t){return F[~~(4*A(t))]}function E(t){return T[~~(4*A(t))]}const M=1440,k=2*Math.PI/M,F=new Float32Array(M),T=new Float32Array(M);for(let t=0;t<M;t++){const e=t*k;F[t]=Math.cos(e),T[t]=Math.sin(e)}const R=t=>{let e=180*t/Math.PI%360;return e<0?e+360:e},z=(t,e,n,i)=>Math.sqrt((n-t)*(n-t)+(i-e)*(i-e)),I=(t,e,n,i)=>R(Math.atan2(-(i-e),n-t));function B(t,e,n,i,r=!1){let o=t.x,s=t.y,a=e.x,l=e.y,c=n.x,u=n.y,f=i.x,h=i.y;if(o===a&&s===l||c===f&&u===h)return!1;let x=a-o,m=l-s,d=f-c,p=h-u,v=p*x-d*m;if(0===v)return!1;let y=(d*(s-u)-p*(o-c))/v,g=(x*(s-u)-m*(o-c))/v;return!(!r&&(g<0||g>1))&&{x:o+y*x,y:s+y*m}}function P(t,e,n,i,r){let o=b(r),s=E(r);return{x:o*(n-t)+s*(i-e)+t,y:o*(i-e)-s*(n-t)+e}}function S(t){return t.map((function(t){return t.slice()}))}Worker.createURL=function(t){const e="function"==typeof t?t.toString():t,n=new Blob(["'use strict';\nself.onmessage ="+e],{type:"text/javascript"});return window.URL.createObjectURL(n)},Worker.create=function(t){return new Worker(Worker.createURL(t))};const C=document.createElement("canvas");C.width=1,C.height=1;const U=C.getContext("2d");class L{constructor(t,e,n){if(isNaN(t)){this.hex=this.standardize(t);let e=this.hexToRgb(this.hex);this.r=e.r,this.g=e.g,this.b=e.b}else t=_(t,0,255),e=_(e,0,255),n=_(n,0,255),this.r=t,this.g=isNaN(e)?t:e,this.b=isNaN(n)?t:n,this.hex=this.rgbToHex(this.r,this.g,this.b);this.gl=[this.r/255,this.g/255,this.b/255,1]}rgbToHex(t,e,n){return"#"+(1<<24|t<<16|e<<8|n).toString(16).slice(1)}hexToRgb(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,n,i){return e+e+n+n+i+i}));let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}standardize(t){return U.fillStyle=t,U.fillStyle}}function N(){!function(){if(!o)throw new Error("Canvas system is not ready. Call `load()` first.")}(),O.load()}const O={loaded:!1,isBlending:!1,currentColor:new L("white").gl,load(){if(!e[n].worker){const t=e[n];t.mask=new OffscreenCanvas(i,r),t.glMask=new OffscreenCanvas(i,r),t.ctx=t.mask.getContext("2d"),t.gl=t.glMask.getContext("webgl2"),t.ctx.lineWidth=0,t.offscreen=e[n].canvas.transferControlToOffscreen(),t.worker=Worker.create((function(t){let e,n;const i={};function r(){let t=o();const e=n.createFramebuffer();return n.bindFramebuffer(n.FRAMEBUFFER,e),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),{texture:t,fbo:e}}function o(){const t=n.createTexture();return n.bindTexture(n.TEXTURE_2D,t),n.texStorage2D(n.TEXTURE_2D,1,n.RGBA8,e.width,e.height),t}function s(){return self.navigator&&/Safari/.test(self.navigator.userAgent)&&!/Chrome/.test(self.navigator.userAgent)}onmessage=async t=>{if(t.data.canvas)e=t.data.canvas,function(){n=e.getContext("webgl2");const t=((t,e,n)=>{const i=t.createProgram();for(let[e,n]of[[t.VERTEX_SHADER,"#version 300 es\n    out vec2 p;void main(){vec3 v=vec3(-1);v[gl_VertexID]=3.;gl_Position=vec4(p=v.xy,0,1);}"],[t.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\nuniform vec4 u_addColor;\nuniform bool u_isErase;\nuniform bool u_isImage;\nuniform float u_flip;\nuniform bool u_isFBO;\nuniform sampler2D u_source,u_mask;\nin vec2 p;\nout vec4 outColor;\nfloat x(float v)\n{\n  return v<.04045?\n    v/12.92:\n    pow((v+.055)/1.055,2.4);\n}\nfloat f(float v)\n{\n  return v<.0031308?\n    v*12.92:\n    1.055*pow(v,1./2.4)-.055;\n}\nvec3 v(vec3 v)\n{\n  return vec3(x(v[0]),x(v[1]),x(v[2]));\n}\nvec3 n(vec3 v)\n{\n  return clamp(vec3(f(v[0]),f(v[1]),f(v[2])),0.,1.);\n}\nvoid f(vec3 e,out float m,out float f,out float v,out float u,out float r,out float x,out float z)\n{\n  m=min(e.x,min(e.y,e.z));\n  e-=m;\n  f=min(e.y,e.z);\n  v=min(e.x,e.z);\n  u=min(e.x,e.y);\n  r=min(max(0.,e.x-e.z),max(0.,e.x-e.y));\n  x=min(max(0.,e.y-e.z),max(0.,e.y-e.x));\n  z=min(max(0.,e.z-e.y),max(0.,e.z-e.x));\n}\nvoid f(vec3 v,inout float u[38])\n{\n  float e,o,x,m,z,w,y;\n  f(v,e,o,x,m,z,w,y);\n  u[0]=max(1e-4,e+o*.96853629+x*.51567122+m*.02055257+z*.03147571+w*.49108579+y*.97901834);\n  u[1]=max(1e-4,e+o*.96855103+x*.5401552+m*.02059936+z*.03146636+w*.46944057+y*.97901649);\n  u[2]=max(1e-4,e+o*.96859338+x*.62645502+m*.02062723+z*.03140624+w*.4016578+y*.97901118);\n  u[3]=max(1e-4,e+o*.96877345+x*.75595012+m*.02073387+z*.03119611+w*.2449042+y*.97892146);\n  u[4]=max(1e-4,e+o*.96942204+x*.92826996+m*.02114202+z*.03053888+w*.0682688+y*.97858555);\n  u[5]=max(1e-4,e+o*.97143709+x*.97223624+m*.02233154+z*.02856855+w*.02732883+y*.97743705);\n  u[6]=max(1e-4,e+o*.97541862+x*.98616174+m*.02556857+z*.02459485+w*.013606+y*.97428075);\n  u[7]=max(1e-4,e+o*.98074186+x*.98955255+m*.03330189+z*.0192952+w*.01000187+y*.96663223);\n  u[8]=max(1e-4,e+o*.98580992+x*.98676237+m*.05185294+z*.01423112+w*.01284127+y*.94822893);\n  u[9]=max(1e-4,e+o*.98971194+x*.97312575+m*.10087639+z*.01033111+w*.02636635+y*.89937713);\n  u[10]=max(1e-4,e+o*.99238027+x*.91944277+m*.24000413+z*.00765876+w*.07058713+y*.76070164);\n  u[11]=max(1e-4,e+o*.99409844+x*.32564851+m*.53589066+z*.00593693+w*.70421692+y*.4642044);\n  u[12]=max(1e-4,e+o*.995172+x*.13820628+m*.79874659+z*.00485616+w*.85473994+y*.20123039);\n  u[13]=max(1e-4,e+o*.99576545+x*.05015143+m*.91186529+z*.00426186+w*.95081565+y*.08808402);\n  u[14]=max(1e-4,e+o*.99593552+x*.02912336+m*.95399623+z*.00409039+w*.9717037+y*.04592894);\n  u[15]=max(1e-4,e+o*.99564041+x*.02421691+m*.97137099+z*.00438375+w*.97651888+y*.02860373);\n  u[16]=max(1e-4,e+o*.99464769+x*.02660696+m*.97939505+z*.00537525+w*.97429245+y*.02060067);\n  u[17]=max(1e-4,e+o*.99229579+x*.03407586+m*.98345207+z*.00772962+w*.97012917+y*.01656701);\n  u[18]=max(1e-4,e+o*.98638762+x*.04835936+m*.98553736+z*.0136612+w*.9425863+y*.01451549);\n  u[19]=max(1e-4,e+o*.96829712+x*.0001172+m*.98648905+z*.03181352+w*.99989207+y*.01357964);\n  u[20]=max(1e-4,e+o*.89228016+x*8.554e-5+m*.98674535+z*.10791525+w*.99989891+y*.01331243);\n  u[21]=max(1e-4,e+o*.53740239+x*.85267882+m*.98657555+z*.46249516+w*.13823139+y*.01347661);\n  u[22]=max(1e-4,e+o*.15360445+x*.93188793+m*.98611877+z*.84604333+w*.06968113+y*.01387181);\n  u[23]=max(1e-4,e+o*.05705719+x*.94810268+m*.98559942+z*.94275572+w*.05628787+y*.01435472);\n  u[24]=max(1e-4,e+o*.03126539+x*.94200977+m*.98507063+z*.96860996+w*.06111561+y*.01479836);\n  u[25]=max(1e-4,e+o*.02205445+x*.91478045+m*.98460039+z*.97783966+w*.08987709+y*.0151525);\n  u[26]=max(1e-4,e+o*.01802271+x*.87065445+m*.98425301+z*.98187757+w*.13656016+y*.01540513);\n  u[27]=max(1e-4,e+o*.0161346+x*.78827548+m*.98403909+z*.98377315+w*.22169624+y*.01557233);\n  u[28]=max(1e-4,e+o*.01520947+x*.65738359+m*.98388535+z*.98470202+w*.32176956+y*.0156571);\n  u[29]=max(1e-4,e+o*.01475977+x*.59909403+m*.98376116+z*.98515481+w*.36157329+y*.01571025);\n  u[30]=max(1e-4,e+o*.01454263+x*.56817268+m*.98368246+z*.98537114+w*.4836192+y*.01571916);\n  u[31]=max(1e-4,e+o*.01444459+x*.54031997+m*.98365023+z*.98546685+w*.46488579+y*.01572133);\n  u[32]=max(1e-4,e+o*.01439897+x*.52110241+m*.98361309+z*.98550011+w*.47440306+y*.01572502);\n  u[33]=max(1e-4,e+o*.0143762+x*.51041094+m*.98357259+z*.98551031+w*.4857699+y*.01571717);\n  u[34]=max(1e-4,e+o*.01436343+x*.50526577+m*.98353856+z*.98550741+w*.49267971+y*.01571905);\n  u[35]=max(1e-4,e+o*.01435687+x*.5025508+m*.98351247+z*.98551323+w*.49625685+y*.01571059);\n  u[36]=max(1e-4,e+o*.0143537+x*.50126452+m*.98350101+z*.98551563+w*.49807754+y*.01569728);\n  u[37]=max(1e-4,e+o*.01435408+x*.50083021+m*.98350852+z*.98551547+w*.49889859+y*.0157002);\n}\nvec3 w(vec3 e)\n{\n  mat3 u;\n  u[0]=vec3(3.24306333,-1.53837619,-.49893282);\n  u[1]=vec3(-.96896309,1.87542451,.04154303);\n  u[2]=vec3(.05568392,-.20417438,1.05799454);\n  float v=dot(u[0],e),x=dot(u[1],e),o=dot(u[2],e);\n  return n(vec3(v,x,o));\n}\nvec3 m(float u[38])\n{\n  return vec3(0)+u[0]*vec3(6.469e-5,1.84e-6,.00030502)+u[1]*vec3(.00021941,6.21e-6,.00103681)+u[2]*vec3(.00112057,3.101e-5,.00531314)+u[3]*vec3(.00376661,.00010475,.01795439)+u[4]*vec3(.01188055,.00035364,.05707758)+u[5]*vec3(.02328644,.00095147,.11365162)+u[6]*vec3(.03455942,.00228226,.17335873)+u[7]*vec3(.03722379,.00420733,.19620658)+u[8]*vec3(.03241838,.0066888,.18608237)+u[9]*vec3(.02123321,.0098884,.13995048)+u[10]*vec3(.01049099,.01524945,.08917453)+u[11]*vec3(.00329584,.02141831,.04789621)+u[12]*vec3(.00050704,.03342293,.02814563)+u[13]*vec3(.00094867,.05131001,.01613766)+u[14]*vec3(.00627372,.07040208,.0077591)+u[15]*vec3(.01686462,.08783871,.00429615)+u[16]*vec3(.02868965,.09424905,.00200551)+u[17]*vec3(.04267481,.09795667,.00086147)+u[18]*vec3(.05625475,.09415219,.00036904)+u[19]*vec3(.0694704,.08678102,.00019143)+u[20]*vec3(.08305315,.07885653,.00014956)+u[21]*vec3(.0861261,.0635267,9.231e-5)+u[22]*vec3(.09046614,.05374142,6.813e-5)+u[23]*vec3(.08500387,.04264606,2.883e-5)+u[24]*vec3(.07090667,.03161735,1.577e-5)+u[25]*vec3(.05062889,.02088521,3.94e-6)+u[26]*vec3(.03547396,.01386011,1.58e-6)+u[27]*vec3(.02146821,.00810264,0)+u[28]*vec3(.01251646,.0046301,0)+u[29]*vec3(.00680458,.00249138,0)+u[30]*vec3(.00346457,.0012593,0)+u[31]*vec3(.00149761,.00054165,0)+u[32]*vec3(.0007697,.00027795,0)+u[33]*vec3(.00040737,.00014711,0)+u[34]*vec3(.00016901,6.103e-5,0)+u[35]*vec3(9.522e-5,3.439e-5,0)+u[36]*vec3(4.903e-5,1.771e-5,0)+u[37]*vec3(2e-5,7.22e-6,0);\n}\nfloat f(float x,float z,float v)\n{\n  z*=pow(v,2.);\n  return z/(x*pow(1.-v,2.)+z);\n}\nvec3 m(vec3 e,vec3 z,float u)\n{\n  float o[38],x[38];\n  f(v(e),o);\n  f(v(z),x);\n  float r=m(o)[1],y=m(x)[1];\n  u=f(r,y,u);\n  float i[38];\n  for(int e=0;e<38;e++)\n    {\n      float v=(1.-u)*(pow(1.-o[e],2.)/(2.*o[e]))+u*(pow(1.-x[e],2.)/(2.*x[e]));\n      i[e]=1.+v-sqrt(pow(v,2.)+2.*v);\n    }\n  return w(m(i));\n}\nvec4 m(vec4 v,vec4 e,float f)\n{\n  return vec4(m(v.xyz,e.xyz,f),mix(v.w,e.w,f));\n}\nvoid main()\n{\n  vec2 e=.5*vec2(p.x,u_flip*p.y)+.5;\n  vec4 v=texture(u_source,e);\n  if(u_isFBO)\n    outColor=v;\n  else if(u_isImage) \n    {\n    outColor = texture(u_mask,e);\n    }\n  else\n    {\n      vec4 f=texture(u_mask,e);\n      if(f.x>0.)\n        {\n          vec4 e=vec4(u_addColor.xyz,1);\n          if(f.w>.7&&!u_isErase)\n            {\n              float v=.5*(f.w-.7);\n              e=e*(1.-v)-vec4(.5)*v;\n            }\n          vec3 u=m(v.xyz,e.xyz,f.w);\n          outColor=vec4(u,1);\n        }\n      else\n         outColor=v;\n    }\n}"]]){const r=t.createShader(e);t.shaderSource(r,n),t.compileShader(r),t.attachShader(i,r)}return t.linkProgram(i),i})(n);let s=["u_flip","u_addColor","u_isErase","u_isFBO","u_source","u_mask","u_isImage"];for(let e of s)i[e]=n.getUniformLocation(t,e);n.useProgram(t),i.mask=o(),i.source=r(),i.target=r(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i.source.texture),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,i.mask),n.uniform1i(i.u_source,0),n.uniform1i(i.u_mask,1)}(),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,i.source.fbo),n.clearColor(1,1,1,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);else if(t.data.isBG)n.bindFramebuffer(n.DRAW_FRAMEBUFFER,i.source.fbo),n.clearColor(...t.data.color),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);else if(t.data.mask)!function(t){let r;if(s()){const e=new OffscreenCanvas(t.mask.width,t.mask.height).getContext("2d");e.drawImage(t.mask,0,0),r=e.getImageData(0,0,t.mask.width,t.mask.height)}n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,s()?r:t.mask),t.mask.close(),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,i.target.fbo),n.uniform1f(i.u_flip,1),n.uniform1i(i.u_isFBO,!1),n.uniform1i(i.u_isImage,!!t.isImage),t.isImage||(n.uniform1i(i.u_isImage,!1),n.uniform4f(i.u_addColor,...t.addColor),n.uniform1i(i.u_isErase,!!t.isErase)),n.drawArrays(n.TRIANGLES,0,3),n.bindFramebuffer(n.READ_FRAMEBUFFER,i.target.fbo),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,i.source.fbo),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST),n.invalidateFramebuffer(n.READ_FRAMEBUFFER,[n.COLOR_ATTACHMENT0]),t.isLast&&!t.sp&&(n.bindFramebuffer(n.FRAMEBUFFER,null),n.uniform1i(i.u_isImage,!1),n.uniform1i(i.u_isFBO,!0),n.uniform1f(i.u_flip,-1),n.drawArrays(n.TRIANGLES,0,3))}(t.data);else if(t.data.get){let t=await createImageBitmap(e);postMessage({canvas:t},[t]),t.close()}}})),t.worker.postMessage("init"),t.worker.postMessage({canvas:t.offscreen},[t.offscreen])}this.mask=e[n].mask,this.glMask=e[n].glMask,this.ctx=e[n].ctx,this.gl=e[n].gl,this.worker=e[n].worker},blend(t=!1,e=!1,n=!1,i=!1){N(),!this.isBlending&&t&&(this.currentColor=t.gl,this.isBlending=!0);const r=t?t.gl:this.currentColor;if(e||n||r.toString()!==this.currentColor.toString()){const r=n||this.glMask.transferToImageBitmap();this.worker.postMessage({addColor:this.currentColor,mask:r,isLast:e,isErase:this.isErase,isImage:Boolean(n),sp:i},[r]),this.isErase=!1,e||(this.currentColor=t.gl),e&&!i&&(this.isBlending=!1)}}};let D=new L("white");const Y={x:0,y:0};let X=!1;function Z(){X||(N(),V=.01*i,q=-.5*i,H=-.5*r,G=Math.round(2*i/V),$=Math.round(2*r/V),J("curved",(function(e,n){const i=v(-20,-10)*(v(0,100)%2==0?-1:1),r=.03*e;for(let e=0;e<G;e++){const o=.01*e+r;for(let s=0;s<$;s++){const a=t.noise(o,.01*s+r);n[e][s]=w(a,0,1,-i,i)}}return n})),J("hand",(function(e,n){const i=p(.2,.8),r=v(5,10),o=.1*e;for(let s=0;s<G;s++){const a=.1*s+o;for(let l=0;l<$;l++){const c=r*E(i*l*s+v(15,25)),u=t.noise(a,.1*l+o);n[s][l]=.5*c*b(e)+u*r*.5}}return n})),J("seabed",(function(t,e){const n=p(.4,.8),i=v(18,26);for(let r=0;r<G;r++)for(let o=0;o<$;o++){const s=i*E(n*o*r+v(15,20));e[r][o]=1.1*s*b(t)}return e})),Q.genField(),X=!0)}class W{constructor(t,e){this.update(t,e),this.plotted=0}update(t,e){this.x=t,this.y=e,this.column_index=W.getColIndex(t),this.row_index=W.getRowIndex(e)}reset(){this.plotted=0}isIn(){return s.field.isActive?W.isIn(this.column_index,this.row_index):this.isInCanvas(this.x,this.y)}isInCanvas(){const t=i,e=r,n=this.x+Y.x,o=this.y+Y.y;return n>=-.3*t&&n<=1.3*t&&o>=-.3*e&&o<=1.3*e}angle(){return this.isIn()&&s.field.isActive?j.get(s.field.current).field[this.column_index][this.row_index]:0}moveTo(t,e,n,i=!0){if(!this.isIn())return void(this.plotted+=n);let r,o;for(let s=0;s<t/n;s++){if(i){const t=this.angle();r=b(t-e),o=E(t-e)}else r=b(-e),o=E(-e);const t=n*r,s=n*o;this.plotted+=n,this.update(this.x+t,this.y+s)}}plotTo(t,e,n,i){if(!this.isIn())return void(this.plotted+=n/i);const r=1/i;for(let i=0;i<e/n;i++){const e=this.angle(),i=t.angle(this.plotted),o=n*b(e-i),s=n*E(e-i);this.plotted+=n*r,this.update(this.x+o,this.y+s)}}static getRowIndex(t){const e=t+Y.y-H;return Math.round(e/V)}static getColIndex(t){const e=t+Y.x-q;return Math.round(e/V)}static isIn(t,e){return t>=0&&e>=0&&t<G&&e<$}}s.field={isActive:!1,current:null};let V,q,H,G,$,j=new Map;function K(){return new Array(G).fill(null).map((()=>new Float32Array($)))}function J(t,e){j.set(t,{gen:e}),j.get(t).field=j.get(t).gen(0,K())}const Q={genField(){this.field=K(),this.fieldTemp=K()},get(t,e,n=!1){const i=W.getColIndex(t),r=W.getRowIndex(e),o=this.field?.[i]?.[r]??0;if(n){const t=Math.max(o,n),e=.75*(this.fieldTemp[i]?.[r]??0);return this.fieldTemp[i][r]=Math.max(t,e),t}return o},update(){for(let t=0;t<G;t++)for(let e=0;e<$;e++)this.field[t][e]=this.fieldTemp[t][e]},save(){this.A=S(this.field),this.B=S(this.fieldTemp)},restore(){this.field=this.A,this.fieldTemp=this.B}};let tt={};const et={isActive:!1,c:null,a:255};function nt(t){Mix.blend(et.c),Mix.isErase=!0,Mix.ctx.save(),Mix.ctx.fillStyle="rgb(255 0 0 / "+et.a+"%)",function(t){O.ctx.beginPath(),t.forEach(((t,e)=>{0===e?O.ctx.moveTo(t.x,t.y):O.ctx.lineTo(t.x,t.y)})),O.ctx.closePath()}(t),Mix.ctx.fill(),Mix.ctx.restore()}class it{constructor(t,e=!1){this.a=t,this.vertices=e?t:t.map((([t,e])=>({x:t,y:e}))),this.sides=this.vertices.map(((t,e,n)=>[t,n[(e+1)%n.length]])),this._intersectionCache={}}intersect(t){const e=`${t.point1.x},${t.point1.y}-${t.point2.x},${t.point2.y}`;if(this._intersectionCache[e])return this._intersectionCache[e];const n=[];for(const[e,i]of this.sides){const r=B(t.point1,t.point2,e,i);r&&n.push(r)}return this._intersectionCache[e]=n,n}erase(){et.isActive&&nt(this.vertices)}show(){s.draw&&this.draw(),s.hatch&&this.hatch(),s.fill&&this.fill(),this.erase()}}class rt{constructor(t){this.segments=[],this.angles=[],this.pres=[],this.type=t,this.dir=0,this.calcIndex(0),this.pol=!1}addSegment(t=0,e=0,n=1,i=!1){this.angles.length>0&&this.angles.pop(),t=i?(t%360+360)%360:R(t),this.angles.push(t,t),this.pres.push(n),this.segments.push(e),this.length=this.segments.reduce(((t,e)=>t+e),0)}endPlot(t=0,e=1,n=!1){t=n?(t%360+360)%360:R(t),this.angles[this.angles.length-1]=t,this.pres.push(e)}rotate(t){this.dir=R(t)}pressure(t){return t>this.length?this.pres[this.pres.length-1]:this.curving(this.pres,t)}angle(t){return t>this.length?this.angles[this.angles.length-1]:(this.calcIndex(t),"curve"===this.type?this.curving(this.angles,t)+this.dir:this.angles[this.index]+this.dir)}curving(t,e){let n=t[this.index],i=t[this.index+1]??n;return Math.abs(i-n)>180&&(i>n?i=-(360-i):n=-(360-n)),w(e-this.suma,0,this.segments[this.index],n,i,!0)}calcIndex(t){this.index=-1,this.suma=0;let e=0;for(;e<=t;)this.suma=e,e+=this.segments[this.index+1],this.index++;return this.index}genPol(t,e,n=1,i){Z();const r=.5,o=[],s=Math.round(this.length/r),a=new W(t,e);let l=0,c=0;for(let t=0;t<s;t++){a.plotTo(this,r,r,1);const t=this.calcIndex(a.plotted);l+=r,(l>=this.segments[t]*i*p(.7,1.3)||t>=c)&&a.x&&(o.push([a.x,a.y]),l=0,t>=c&&c++)}return new it(o)}erase(t,e,n){et.isActive&&(this.origin&&([t,e,n]=[...this.origin,1]),this.pol=this.genPol(t,e,n,.15),nt(this.pol.vertices))}show(t,e,n=1){s.stroke&&this.draw(t,e,n),s.hatch&&this.hatch(t,e,n),s.fill&&this.fill(t,e,n),this.erase(t,e,n)}}let ot,st,at,lt,ct;class ut{constructor(){this.isClosed=!1,this.curvature=at,this.vert=[]}vertex(t,e,n){this.vert.push([t,e,n])}show(){pt(this.vert,this.curvature,this.isClosed).show()}}function ft(t=0){at=_(t,0,1),ot=[]}function ht(t,e,n=1){st=new ut,ot.push(st),st.vertex(t,e,n)}function xt(t,e,n=1){st.vertex(t,e,n)}function mt(){st.vertex(...st.vert[0]),st.isClosed=!0}function dt(){for(let t of ot)t.show();ot=!1}function pt(t,e=.5,n=!1){const i=new rt(0===e?"segments":"curve"),r=2*Math.PI;if(n&&0!==e&&t.push(t[1]),t&&t.length>0){let o,s,a,l=0;for(let c=0;c<t.length-1;c++)if(e>0&&c<t.length-2){const u=t[c],f=t[c+1],h=t[c+2],x=z(u[0],u[1],f[0],f[1]),m=z(f[0],f[1],h[0],h[1]),d=I(u[0],u[1],f[0],f[1]),p=I(f[0],f[1],h[0],h[1]),v=e*Math.min(x,m,.5*Math.min(x,m)),y=Math.max(x,m),g=x-v,w=m-v;if(Math.floor(d)===Math.floor(p)){const e=n&&0===c?0:x-l,r=n?0===c?0:m-a:m;i.addSegment(d,e,u[2],!0),c===t.length-3&&i.addSegment(p,r,f[2],!0),l=0,0===c&&(o=x,a=v,s=t[1],l=0)}else{const e={x:f[0]-v*b(-d),y:f[1]-v*E(-d)},h={x:e.x+y*b(90-d),y:e.y+y*E(90-d)},x={x:f[0]+v*b(-p),y:f[1]+v*E(-p)},m=B(e,h,x,{x:x.x+y*b(90-p),y:x.y+y*E(90-p)},!0),_=z(e.x,e.y,m.x,m.y),A=z(e.x,e.y,x.x,x.y)/2,M=r*_*(2*Math.asin(A/_)*(180/Math.PI))/360,k=n&&0===c?0:g-l,F=c===t.length-3?n?o-v:w:0;i.addSegment(d,k,u[2],!0),i.addSegment(d,isNaN(M)?0:M,u[2],!0),i.addSegment(p,F,f[2],!0),l=v,0===c&&(o=g,a=v,s=[e.x,e.y])}c===t.length-3&&i.endPlot(p,f[2],!0)}else if(0===e){const e=t[c],n=t[c+1],r=z(e[0],e[1],n[0],n[1]),o=I(e[0],e[1],n[0],n[1]);i.addSegment(o,r,n[2],!0),c===t.length-2&&i.endPlot(o,1,!0)}i.origin=n&&0!==e?s:t[0]}return i}let vt,yt=0,gt=!0,wt=30;t.frameCount=0;let _t=t=>(t&&(wt=t),wt);function At(e){gt&&(e>yt+1e3/_t()||0===e)&&(yt=e,t.frameCount++,vt&&vt(),bt()),requestAnimationFrame(At)}function bt(){O.blend(!1,!0)}function Et(t,e){if(!t)return t;e||(e=t);let n,i=t;do{if(n=!1,i.steiner||!St(i,i.next)&&0!==Pt(i.prev,i,i.next))i=i.next;else{if(Yt(i),i=e=i.prev,i===i.next)break;n=!0}}while(n||i!==e);return e}function Mt(t,e,n,i,r,o,s){if(!t)return;!s&&o&&function(t,e,n,i){let r=t;do{0===r.z&&(r.z=zt(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,n=1;do{let i,r=t;t=null;let o=null;for(e=0;r;){e++;let s=r,a=0;for(let t=0;t<n&&(a++,s=s.nextZ,s);t++);let l=n;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||r.z<=s.z)?(i=r,r=r.nextZ,a--):(i=s,s=s.nextZ,l--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;r=s}o.nextZ=null,n*=2}while(e>1)}(r)}(t,i,r,o);let a=t;for(;t.prev!==t.next;){const l=t.prev,c=t.next;if(o?Ft(t,i,r,o):kt(t))e.push(l.i,t.i,c.i),Yt(t),t=c.next,a=c.next;else if((t=c)===a){s?1===s?Mt(t=Tt(Et(t),e),e,n,i,r,o,2):2===s&&Rt(t,e,n,i,r,o):Mt(Et(t),e,n,i,r,o,1);break}}}function kt(t){const e=t.prev,n=t,i=t.next;if(Pt(e,n,i)>=0)return!1;const r=e.x,o=n.x,s=i.x,a=e.y,l=n.y,c=i.y,u=Math.min(r,o,s),f=Math.min(a,l,c),h=Math.max(r,o,s),x=Math.max(a,l,c);let m=i.next;for(;m!==e;){if(m.x>=u&&m.x<=h&&m.y>=f&&m.y<=x&&It(r,a,o,l,s,c,m.x,m.y)&&Pt(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function Ft(t,e,n,i){const r=t.prev,o=t,s=t.next;if(Pt(r,o,s)>=0)return!1;const a=r.x,l=o.x,c=s.x,u=r.y,f=o.y,h=s.y,x=Math.min(a,l,c),m=Math.min(u,f,h),d=Math.max(a,l,c),p=Math.max(u,f,h),v=zt(x,m,e,n,i),y=zt(d,p,e,n,i);let g=t.prevZ,w=t.nextZ;for(;g&&g.z>=v&&w&&w.z<=y;){if(g.x>=x&&g.x<=d&&g.y>=m&&g.y<=p&&g!==r&&g!==s&&It(a,u,l,f,c,h,g.x,g.y)&&Pt(g.prev,g,g.next)>=0)return!1;if(g=g.prevZ,w.x>=x&&w.x<=d&&w.y>=m&&w.y<=p&&w!==r&&w!==s&&It(a,u,l,f,c,h,w.x,w.y)&&Pt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;g&&g.z>=v;){if(g.x>=x&&g.x<=d&&g.y>=m&&g.y<=p&&g!==r&&g!==s&&It(a,u,l,f,c,h,g.x,g.y)&&Pt(g.prev,g,g.next)>=0)return!1;g=g.prevZ}for(;w&&w.z<=y;){if(w.x>=x&&w.x<=d&&w.y>=m&&w.y<=p&&w!==r&&w!==s&&It(a,u,l,f,c,h,w.x,w.y)&&Pt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Tt(t,e){let n=t;do{const i=n.prev,r=n.next.next;!St(i,r)&&Ct(i,n,n.next,r)&&Nt(i,r)&&Nt(r,i)&&(e.push(i.i,n.i,r.i),Yt(n),Yt(n.next),n=t=r),n=n.next}while(n!==t);return Et(n)}function Rt(t,e,n,i,r,o){let s=t;do{let t=s.next.next;for(;t!==s.prev;){if(s.i!==t.i&&Bt(s,t)){let a=Ot(s,t);return s=Et(s,s.next),a=Et(a,a.next),Mt(s,e,n,i,r,o,0),void Mt(a,e,n,i,r,o,0)}t=t.next}s=s.next}while(s!==t)}function zt(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function It(t,e,n,i,r,o,s,a){return!(t===s&&e===a)&&function(t,e,n,i,r,o,s,a){return(r-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(i-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(r-s)*(i-a)}(t,e,n,i,r,o,s,a)}function Bt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Ct(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Nt(t,e)&&Nt(e,t)&&function(t,e){let n=t,i=!1;const r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(Pt(t.prev,t,e.prev)||Pt(t,e.prev,e))||St(t,e)&&Pt(t.prev,t,t.next)>0&&Pt(e.prev,e,e.next)>0)}function Pt(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function St(t,e){return t.x===e.x&&t.y===e.y}function Ct(t,e,n,i){const r=Lt(Pt(t,e,n)),o=Lt(Pt(t,e,i)),s=Lt(Pt(n,i,t)),a=Lt(Pt(n,i,e));return r!==o&&s!==a||!(0!==r||!Ut(t,n,e))||!(0!==o||!Ut(t,i,e))||!(0!==s||!Ut(n,t,i))||!(0!==a||!Ut(n,e,i))}function Ut(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Lt(t){return t>0?1:t<0?-1:0}function Nt(t,e){return Pt(t.prev,t,t.next)<0?Pt(t,e,t.next)>=0&&Pt(t,t.prev,e)>=0:Pt(t,e,t.prev)<0||Pt(t,t.next,e)<0}function Ot(t,e){const n=Xt(t.i,t.x,t.y),i=Xt(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Dt(t,e,n,i){const r=Xt(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Yt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Xt(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}let Zt=!1;function Wt(){Zt||(N(),ee=O.gl,ne=new Float32Array([2/i,0,0,0,0,-2/r,0,0,0,0,1,0,-1,1,0,1]),Gt=function(t,e,n){const i=Ht(t,t.VERTEX_SHADER,e),r=Ht(t,t.FRAGMENT_SHADER,n),o=t.createProgram();return t.attachShader(o,i),t.attachShader(o,r),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(console.error("Program link error: "+t.getProgramInfoLog(o)),null)}(ee,Vt,qt),ee.useProgram(Gt),ee.enable(ee.BLEND),ee.blendFunc(ee.ONE_MINUS_DST_ALPHA,ee.ONE),ee.blendEquation(ee.FUNC_ADD),$t=ee.getAttribLocation(Gt,"a_position"),jt=ee.getAttribLocation(Gt,"a_radius"),Kt=ee.getAttribLocation(Gt,"a_alpha"),Jt=ee.getUniformLocation(Gt,"u_matrix"),Qt=ee.getUniformLocation(Gt,"u_color"),te=ee.getUniformLocation(Gt,"u_drawSquare"),ie=ee.getUniformLocation(Gt,"u_usePointSprite"),Zt=!0)}const Vt="#version 300 es\nin vec2 a_position;\nin float a_radius;\nin float a_alpha;\nuniform mat4 u_matrix;\nout float v_alpha;\nvoid main() {\n  gl_Position = u_matrix * vec4(a_position, 0, 1);\n  v_alpha = a_alpha;\n  gl_PointSize = a_radius * 2.0;\n}\n",qt="#version 300 es\nprecision highp float;\nuniform vec3 u_color;                   // Base color.\nuniform bool u_drawSquare;              // For point sprites.\nuniform bool u_usePointSprite;          // true for point sprites; false for triangles (polygons).\nin float v_alpha;\nout vec4 outColor;\nvoid main() {\n  // When using point sprites (circles/squares), use gl_PointCoord.\n  if(u_usePointSprite) {\n    if(u_drawSquare) {\n      outColor = vec4(u_color * v_alpha, v_alpha);\n    } else {\n      vec2 coord = gl_PointCoord - vec2(0.5);\n      float d = length(coord);\n      if (d > 0.5) {\n        discard;\n      }\n      float edgeFactor = smoothstep(0.45, 0.5, d);\n      outColor = vec4(u_color * v_alpha, v_alpha * (1.0 - edgeFactor));\n    }\n  } else {\n    // For polygon triangles, simply output a uniform fill.\n    outColor = vec4(u_color * v_alpha, v_alpha);\n  }\n}\n";function Ht(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),i}let Gt,$t,jt,Kt,Jt,Qt,te,ee,ne,ie;function re(t=!1){t&&ee.blendFunc(ee.ZERO,ee.ONE_MINUS_SRC_ALPHA);const e=ee.createVertexArray(se);ee.bindVertexArray(e),ee.uniform1i(ie,1);const n=new Float32Array(4*oe.length);for(let t=0;t<oe.length;t++){const e=4*t;n[e+0]=oe[t].x,n[e+1]=oe[t].y,n[e+2]=oe[t].radius,n[e+3]=oe[t].alpha}oe=[];const i=ee.createBuffer();ee.bindBuffer(ee.ARRAY_BUFFER,i),ee.bufferData(ee.ARRAY_BUFFER,n,ee.STATIC_DRAW);const r=4*Float32Array.BYTES_PER_ELEMENT;ee.enableVertexAttribArray($t),ee.vertexAttribPointer($t,2,ee.FLOAT,!1,r,0),ee.enableVertexAttribArray(jt),ee.vertexAttribPointer(jt,1,ee.FLOAT,!1,r,2*Float32Array.BYTES_PER_ELEMENT),ee.enableVertexAttribArray(Kt),ee.vertexAttribPointer(Kt,1,ee.FLOAT,!1,r,3*Float32Array.BYTES_PER_ELEMENT),ee.uniformMatrix4fv(Jt,!1,ne),ee.uniform3fv(Qt,new Float32Array([1,0,0])),ee.uniform1i(te,se?1:0);const o=n.length/4;ee.bindVertexArray(e),ee.drawArrays(ee.POINTS,0,o),ee.bindVertexArray(null),ee.blendFunc(ee.ONE_MINUS_DST_ALPHA,ee.ONE)}let oe=[],se=!1;function ae(t,e,n,i){Wt();const r=n/2;oe.push({x:t+Y.x,y:e+Y.y,radius:r,alpha:i/100}),se=!1}function le(t,e,n,i){Wt();const r=n/2/1.2;oe.push({x:t+Y.x,y:e+Y.y,radius:r,alpha:i/100}),se=!0}let ce=[];function ue(){ce.length&&(ee.uniform1i(ie,0),ce.forEach((t=>{const e=function(t,e,n=2){const i=t.length;let r=function(t,e,n,i,r){let o;if(1==function(t,e,n,i){let r=0;for(let e=0,o=n-i;e<n;e+=i)r+=(t[o]-t[e])*(t[e+1]+t[o+1]),o=e;return r}(t,0,n,i)>0)for(let e=0;e<n;e+=i)o=Dt(e/i|0,t[e],t[e+1],o);else for(let e=n-i;e>=0;e-=i)o=Dt(e/i|0,t[e],t[e+1],o);return o&&St(o,o.next)&&(Yt(o),o=o.next),o}(t,0,i,n);const o=[];if(!r||r.next===r.prev)return o;let s,a,l;if(t.length>80*n){s=Infinity,a=Infinity;let e=-Infinity,r=-Infinity;for(let o=n;o<i;o+=n){const n=t[o],i=t[o+1];n<s&&(s=n),i<a&&(a=i),n>e&&(e=n),i>r&&(r=i)}l=Math.max(e-s,r-a),l=0!==l?32767/l:0}return Mt(r,o,n,s,a,l,0),o}(t.points),n=e.length,i=new Float32Array(4*n);for(let r=0;r<n;r++){const n=2*e[r];i[4*r+0]=t.points[n],i[4*r+1]=t.points[n+1],i[4*r+2]=1,i[4*r+3]=t.alpha}const r=ee.createVertexArray();ee.bindVertexArray(r);const o=ee.createBuffer();ee.bindBuffer(ee.ARRAY_BUFFER,o),ee.bufferData(ee.ARRAY_BUFFER,i,ee.STATIC_DRAW);const s=4*Float32Array.BYTES_PER_ELEMENT;ee.enableVertexAttribArray($t),ee.vertexAttribPointer($t,2,ee.FLOAT,!1,s,0),ee.enableVertexAttribArray(jt),ee.vertexAttribPointer(jt,1,ee.FLOAT,!1,s,2*Float32Array.BYTES_PER_ELEMENT),ee.enableVertexAttribArray(Kt),ee.vertexAttribPointer(Kt,1,ee.FLOAT,!1,s,3*Float32Array.BYTES_PER_ELEMENT),ee.uniformMatrix4fv(Jt,!1,ne),ee.uniform3fv(Qt,new Float32Array([1,0,0])),ee.uniform1i(te,0),ee.bindVertexArray(r),ee.drawArrays(ee.TRIANGLES,0,n),ee.bindVertexArray(null),ee.deleteBuffer(o),ee.deleteVertexArray(r)})),ce=[])}const fe=2*Math.PI;s.stroke={color:new L("black"),weight:1,clipWindow:null,type:"HB",isActive:!1};let he,xe,me,de,pe,ve=new Map;function ye(){return{...s.stroke}}function ge(t){s.stroke={...t}}function we(t,e){e.type=["marker","custom","image","spray"].includes(e.type)?e.type:"default",ve.set(t,{param:e,colors:[],buffers:[]})}function _e(t){ve.has(t)&&(s.stroke.type=t)}function Ae(t,e,n){s.stroke.color=new L(...arguments),s.stroke.isActive=!0}function be(t){s.stroke.weight=t}function Ee(t,e,n=1){_e(t),Ae(e),be(n)}function Me(t,e,n,i,r){he=new W(t,e),xe=n,me=i,de=r,de&&de.calcIndex(0)}function ke(t,e){e||(pe=t),function(){Fe.seed=99999*p();const{param:t}=ve.get(s.stroke.type)??{};if(!t)return;Fe.p=t;const{pressure:e}=t;Fe.a="custom"!==e.type?p(-1,1):0,Fe.b="custom"!==e.type?p(1,1.5):0,Fe.cp="custom"!==e.type?p(3,3.5):p(-.2,.2),[Fe.min,Fe.max]=e.min_max,Wt(),O.blend(s.stroke.color),O.isBrush=!0,Fe.alpha=Be(),Ce()}();const n=function(){const{param:t}=ve.get(s.stroke.type)??{};return t?"default"===t.type||"spray"===t.type?t.spacing/s.stroke.weight:t.spacing:1}(),i=Math.round(xe*(e?t:1)/n);for(let r=0;r<i;r++)Te(),e?he.plotTo(de,n,n,t,r<10):he.moveTo(n,t,n,me);re(!0),Ce()}const Fe={};function Te(e=!1){if(!Pe())return;let n=e||Re();switch(n*=1-.3*t.noise(.007*he.x+Fe.seed,.007*he.y+Fe.seed)-.1*t.noise(.002*he.x,.002*he.y),Fe.p.type){case"spray":!function(t){const e=s.stroke.weight*Fe.p.vibration*t+s.stroke.weight*y()*Fe.p.vibration/3,n=s.stroke.weight*p(.9,1.1),i=Math.ceil(Fe.p.quality/t);for(let t=0;t<i;t++){const t=p(.9,1.1),i=t*e*p(-1,1),r=p(-1,1),o=Math.sqrt((t*e)**2-i**2);le(he.x+i,he.y+r*o,n,Fe.alpha)}}(n);break;case"marker":Se(n);break;case"custom":case"image":!function(t,e,n=!0){O.ctx.save();const i=n?s.stroke.weight*Fe.p.vibration:0,r=n?i*p(-1,1):0,o=n?i*p(-1,1):0;O.ctx.translate(he.x+r,he.y+o),function(t,e){O.ctx.scale(t,t);let n=0;"random"===Fe.p.rotate?n=v(0,fe):"natural"===Fe.p.rotate&&(n=(de?-de.angle(he.plotted):-pe)+(me?he.angle():0),n=n*Math.PI/180),O.ctx.rotate(n)}(s.stroke.weight*t),Fe.p.tip(O.ctx),O.ctx.restore()}(n);break;default:!function(t){const e=s.stroke.weight*Fe.p.vibration*(Fe.p.definition+(1-Fe.p.definition)*y()*Ie(.5,.9,5,.2,1.2)/t);p(0,Fe.p.quality*t)>.4&&le(he.x+.7*e*p(-1,1),he.y+e*p(-1,1),t*Fe.p.weight*p(.85,1.15),Fe.alpha)}(n)}}function Re(){return de?ze()*de.pressure(he.plotted):ze()}function ze(){return"custom"===Fe.p.pressure.type?w(Fe.p.pressure.curve(he.plotted/xe)+Fe.cp,0,1,Fe.min,Fe.max,!0):Ie()}function Ie(t=.5+Fe.p.pressure.curve[0]*Fe.a,e=1-Fe.p.pressure.curve[1]*Fe.b,n=Fe.cp,i=Fe.min,r=Fe.max){return w(1/(1+Math.pow(Math.abs((he.plotted-t*xe)/(e*xe/2)),2*n)),0,1,i,r)}function Be(){return["default","spray"].includes(Fe.p.type)?Fe.p.opacity:Fe.p.opacity/s.stroke.weight}function Pe(){if(s.stroke.clipWindow)return he.x>=s.stroke.clipWindow[0]&&he.x<=s.stroke.clipWindow[2]&&he.y>=s.stroke.clipWindow[1]&&he.y<=s.stroke.clipWindow[3];{let t=i,e=r,n=.05*i,o=he.x+Y.x,s=he.y+Y.y;return o>=-n&&o<=t+n&&s>=-n&&s<=e+n}}function Se(t,e=!0,n=Fe.alpha){const i=e?s.stroke.weight*Fe.p.vibration:0,r=e?i*p(-1,1):0,o=e?i*p(-1,1):0;ae(he.x+r,he.y+o,s.stroke.weight*Fe.p.weight*t,n)}function Ce(){if(Pe()){let t=Re(),e=Be();if("marker"===Fe.p.type){for(let n=1;n<10;n++)Se(t*n/10,!1,5*e);re()}else if("custom"===Fe.p.type||"image"===Fe.p.type)for(let n=1;n<5;n++)O.ctx.beginPath(),Fe.drawCustomOrImage(t*n/5,e,!1),O.ctx.fill()}}function Ue(t,e,n,i){Z();let r=z(t,e,n,i);0!=r&&(Me(t,e,r,!0,!1),ke(I(t,e,n,i),!1))}const Le=["weight","vibration","definition","quality","opacity","spacing","pressure","type","tip","rotate"],Ne=[["pen",[.35,.12,.5,8,88,.3,{curve:[.15,.2],min_max:[1.4,.9]}]],["rotring",[.2,.05,.5,30,115,.15,{curve:[.35,.2],min_max:[1.3,.9]}]],["2B",[.35,.6,.1,8,140,.2,{curve:[.15,.2],min_max:[1.5,1]}]],["HB",[.3,.5,.4,4,130,.25,{curve:[.15,.2],min_max:[1.2,.9]}]],["2H",[.2,.4,.3,2,60,.2,{curve:[.15,.2],min_max:[1.2,.9]}]],["cpencil",[.4,.55,.8,7,70,.15,{curve:[.15,.2],min_max:[.95,1.2]}]],["charcoal",[.35,1.5,.65,300,60,.06,{curve:[.15,.2],min_max:[1.3,.9]}]],["crayon",[.25,2,.8,300,60,.06,{curve:[.35,.2],min_max:[.9,1.1]}]],["spray",[.2,12,15,40,35,.65,{curve:[0,.1],min_max:[1,1]},"spray"]],["marker",[2.5,.12,null,null,.4,.04,{curve:[.35,.25],min_max:[1.5,1]},"marker"]]];for(let t of Ne){let e={};for(let n=0;n<t[1].length;n++)e[Le[n]]=t[1][n];we(t[0],e)}function Oe(){return{...s.hatch}}function De(t=5,e=45,n={rand:!1,continuous:!1,gradient:!1}){let i=s.hatch;i.isActive=!0,i.dist=t,i.angle=e,i.options=n}function Ye(t){let e=s.hatch.dist,n=s.hatch.angle,i=s.hatch.options,r=ye();s.hatch.hBrush&&Ee(...Object.values(s.hatch.hBrush)),n=R(n)%180,Array.isArray(t)||(t=[t]);const o=function(t){let e={minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};for(let n of t){const t=Xe(n);e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}return e}(t);let a=new it([[o.minX,o.minY],[o.maxX,o.minY],[o.maxX,o.maxY],[o.minX,o.maxY]]),l=n<=90&&n>=0?o.minY:o.maxY,c=i.gradient?w(i.gradient,0,1,1,1.1,!0):1,u=[],f=0,h=e,x=t=>({point1:{x:o.minX+h*t*b(90-n),y:l+h*t*E(90-n)},point2:{x:o.minX+h*t*b(90-n)+b(-n),y:l+h*t*E(90-n)+E(-n)}});for(;a.intersect(x(f)).length>0;){let e=[];for(let n of t)e.push(n.intersect(x(f)));u[f]=e.flat().sort(((t,e)=>t.x===e.x?t.y-e.y:t.x-e.x)),h*=c,f++}let m=[];for(let t of u)void 0!==t[0]&&m.push(t);let d=i.rand?i.rand:0;for(let t=0;t<m.length;t++){let n=m[t],r=t>0&&i.continuous;for(let i=0;i<n.length-1;i+=2)0!==d&&(n[i].x+=d*e*p(-10,10),n[i].y+=d*e*p(-10,10),n[i+1].x+=d*e*p(-10,10),n[i+1].y+=d*e*p(-10,10)),Ue(n[i].x,n[i].y,n[i+1].x,n[i+1].y),r&&Ue(m[t-1][1].x,m[t-1][1].y,n[i].x,n[i].y)}ge(r)}function Xe(t){if(t._boundingBox)return t._boundingBox;let e=Infinity,n=Infinity,i=-Infinity,r=-Infinity;for(let o=0;o<t.a.length;o++){const[s,a]=t.a[o];s<e&&(e=s),s>i&&(i=s),a<n&&(n=a),a>r&&(r=a)}return t._boundingBox={minX:e,minY:n,maxX:i,maxY:r},t._boundingBox}function Ze(){return{...s.fill}}function We(t,e,n,i){s.fill.opacity=(arguments.length<4?e:i)||60,s.fill.color=arguments.length<3?new L(t):new L(t,e,n),s.fill.isActive=!0}function Ve(t,e="out"){s.fill.bleed_strength=_(t,0,1),s.fill.direction=e}function qe(t=.4,e=.4){s.fill.texture_strength=_(t,0,1),s.fill.border_strength=_(e,0,1)}let He;it.prototype.draw=function(t=!1,e,n){let i=ye();if(t&&Ee(t,e,n),i.isActive)for(let t of this.sides)Ue(t[0].x,t[0].y,t[1].x,t[1].y);ge(i)},rt.prototype.draw=function(t,e,n){ye().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],n=1),function(t,e,n,i){Z(),Me(e,n,t.length,!0,t),ke(i,!0)}(this,t,e,n))},s.hatch={isActive:!1,dist:5,angle:45,options:{},hBrush:!1},it.prototype.hatch=function(t=!1,e,n){let i=Oe();t&&De(t,e,n),i.isActive&&Ye(this),function(t){s.hatch={...t}}(i)},rt.prototype.hatch=function(t,e,n){Oe().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],n=1),this.pol=this.genPol(t,e,n,.25),this.pol.hatch())},s.fill={color:new L("#002185"),opacity:60,bleed_strength:.07,texture_strength:.8,border_strength:.5,direction:"out",isActive:!1};class Ge{constructor(t,e,n,i,r=!1){this.v=t,this.dir=i,this.m=e,this.midP=n,this.sizeX=-Infinity,this.sizeY=-Infinity;for(let t of this.v)this.sizeX=Math.max(Math.abs(this.midP.x-t.x),this.sizeX),this.sizeY=Math.max(Math.abs(this.midP.y-t.y),this.sizeY);if(r)for(let t=0;t<this.v.length;t++){const e=this.v[t],n=this.v[(t+1)%this.v.length],i={x:n.x-e.x,y:n.y-e.y},r=P(0,0,i.x,i.y,90);let o={point1:{x:e.x+i.x/2,y:e.y+i.y/2},point2:{x:e.x+i.x/2+r.x,y:e.y+i.y/2+r.y}};const s=(t,e,n)=>(e.x-t.x)*(n.y-t.y)-(e.y-t.y)*(n.x-t.x)>.01;let a=0;for(let t of He.intersect(o))s(e,n,t)&&a++;this.dir[t]=a%2==0}}trim(t=1){let e=[...this.v],n=[...this.m],i=[...this.dir];if(this.v.length>8&&t>=0&&1!==t){let r=~~((1-t)*this.v.length),o=~~this.v.length/2-~~r/2;e.splice(o,r),n.splice(o,r),i.splice(o,r)}return{v:e,m:n,dir:i}}grow(t=1,e){const n=[],i=[],r=[],o=this.trim(t),a=o.v,l=o.m,c=o.dir,u=a.length,f=e?-.5:1,h="out"===s.fill.direction?-90:90;let x=!1;switch(t){case 999:x=p(.2,.4);break;case 997:x=s.fill.bleed_strength/1.7}for(let t=0;t<u;t++){const e=a[t],o=a[(t+1)%u];let s=x||Q.get(e.x,e.y,l[t]);s*=f;let d={x:o.x-e.x,y:o.y-e.y},v=(c[t]?h:-h)+45*p(-.4,.4),g=P(0,0,d.x,d.y,v),w=p(.35,.65),_=y(.5,.2)*p(.65,1.35)*s,A={x:e.x+d.x*w+g.x*_,y:e.y+d.y*w+g.y*_};n.push(e,A),i.push(l[t],l[t]+function(t=0,e=1){return t-2*e+(m()+m()+m())/3*e*4}(0,.02)),r.push(c[t],c[t])}return new Ge(n,i,this.midP,r)}fill(t,e,n){const i=3*n,r=2*e;O.blend(t),O.isBrush=!0;let o,s=this.grow();for(let n=0;n<24;n++){n%4==0&&(s=s.grow()),o=[s.grow(1-.0125*n),s.grow(.7-.0125*n),s.grow(.4-.0125*n)];for(let t of o)t.grow(997).grow().layer(n,r);s.grow(.1).grow(999).layer(n,r),0!==i&&s.erase(5*i,e),n%6==0&&(O.blend(t,!0,!1,!0),ue())}ue(),Q.update()}layer(t,e){Math.max(this.sizeX,this.sizeY),function(t,e){Wt();const n=[];t.forEach((t=>{n.push(t.x+Y.x,t.y+Y.y)})),ce.push({points:n,alpha:e/100})}(this.v,e)}erase(t,e){let n=p(50,70)*w(t,0,1,2,3);const i=this.sizeX/2,r=this.sizeY/2,o=Math.min(this.sizeX,this.sizeY)*(1.4-s.fill.bleed_strength),a=.015*o,l=.2*o,c=this.midP.x,u=this.midP.y;for(let t=0;t<n;t++)ae(c+y(0,i),u+y(0,r),p(a,l),t/50);re(!0)}}it.prototype.fill=function(t=!1,e,n,i,r,o){let a=Ze();t&&(We(t,e),Ve(n,o),qe(i,r)),a.isActive&&(Z(),function(t){He=t;let e=[...t.vertices];const n=e.length,i=.25*n*g({1:5,2:10,3:60}),r=s.fill.bleed_strength;let o=e.map(((t,e)=>{let n=p(.85,1.2)*r;return e>i?n:.2*n})),a=v(0,n);e=[...e.slice(a),...e.slice(0,a)],new Ge(e,o,function(t){var e=(t=[...t])[0],n=t[t.length-1];e.x==n.x&&e.y==n.y||t.push(e);for(var i,r,o,s=0,a=0,l=0,c=t.length,u=0,f=c-1;u<c;f=u++)i=t[u],r=t[f],s+=o=(i.y-e.y)*(r.x-e.x)-(r.y-e.y)*(i.x-e.x),a+=(i.x+r.x-2*e.x)*o,l+=(i.y+r.y-2*e.y)*o;return{x:a/(o=3*s)+e.x,y:l/o+e.y}}(e),[],!0).fill(s.fill.color,w(s.fill.opacity,0,100,0,1,!0),s.fill.texture_strength,!0)}(this)),function(t){s.fill={...t}}(a)},rt.prototype.fill=function(t,e,n){Ze().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],n=1),this.pol=this.genPol(t,e,n,3*s.fill.bleed_strength),this.pol.fill())},t.Color=L,t.Plot=rt,t.Polygon=it,t.Position=W,t.add=we,t.addField=J,t.arc=function(t,e,n,i,r){const o=new rt("curve"),s=270-R(i),a=270-R(r),l=R(r-i),c=Math.PI*n*l/180;o.addSegment(s,c,1,!0),o.endPlot(a,1,!0);const u=t+n*b(-s-90),f=e+n*E(-s-90);o.draw(u,f,1)},t.background=function(t,e,n){N(),D=new L(...arguments),O.worker.postMessage({color:D.gl,isBG:!0})},t.beginPath=ft,t.beginStroke=function(t,e,n){ct=[e,n],lt=new rt(t)},t.box=function(){return[...ve.keys()]},t.circle=function(t,e,n,i=!1){const r=new rt("curve"),o=Math.PI*n,s=p(0,360),a=i?()=>1+.2*p():()=>1;for(let t=0;t<4;t++){const e=-90*t+s;r.addSegment(e*a(),o/2*a(),1,!0)}if(i){const t=v(-5,5);r.addSegment(s,Math.abs(t)*(Math.PI/180)*n,1,!0),r.endPlot(t+s,1,!0)}else r.endPlot(s,1,!0);const l=t-n*E(s),c=e-n*b(-s);r.show(l,c,1)},t.clip=function(t){s.stroke.clipWindow=t},t.closePath=mt,t.draw=bt,t.drawImage=function(t,e=0,n=0,i=t.width,r=t.height){N(),"[object ImageBitmap]"===Object.prototype.toString.call(t)&&0===e||(O.ctx.drawImage(t,e,n,i,r),t=O.mask.transferToImageBitmap()),O.blend(!1,!1,t)},t.endPath=dt,t.endStroke=function(t,e){lt.endPlot(t,e),lt.draw(ct[0],ct[1],1),lt=!1},t.erase=function(t=_bg_Color,e=255){et.isActive=!0,et.c=new L(t),et.a=e},t.field=function(t){if(!j.has(t))throw new Error(`Field "${name}" does not exist.`);s.field.isActive=!0,s.field.current=t},t.fillBleed=Ve,t.fillStyle=We,t.fillTexture=qe,t.frameRate=_t,t.getCanvas=async function(){return N(),new Promise((t=>{O.worker.postMessage({get:!0}),O.worker.onmessage=e=>{0!==e.data&&t(e.data.canvas)}}))},t.hatch=De,t.hatchArray=Ye,t.hatchStyle=function(t,e="black",n=1){s.hatch.hBrush={brush:t,color:e,weight:n}},t.line=Ue,t.lineTo=xt,t.lineWidth=be,t.listFields=function(){return Array.from(j.keys())},t.load=function(t,s){n=t,e[n]||(e[n]={canvas:s}),i=e[n].canvas.width,r=e[n].canvas.height,o||(o=!0)},t.loop=function(t=!1){t&&(vt=t),gt=!0,requestAnimationFrame(At)},t.move=function(t,e,n){lt.addSegment(t,e,n)},t.moveTo=ht,t.noClip=function(){s.stroke.clipWindow=null},t.noErase=function(){et.isActive=!1},t.noField=function(){s.field.isActive=!1},t.noFill=function(){s.fill.isActive=!1},t.noHatch=function(){s.hatch.isActive=!1,s.hatch.hBrush=!1},t.noLoop=function(){gt=!1},t.noStroke=function(){s.stroke.isActive=!1},t.noiseSeed=function(e){t.noise=f(h(e))},t.pick=_e,t.polygon=function(t){new it(t).show()},t.random=function(t=0,e=1){return Array.isArray(t)?t[~~(m()*t.length)]:1===arguments.length?m()*t:p(...arguments)},t.rect=function(t,e,n,i,r="corner"){"center"===r&&(t-=n/2,e-=i/2),ft(0),ht(t,e),xt(t+n,e),xt(t+n,e+i),xt(t,e+i),mt(),dt()},t.refreshField=function(t=0){j.get(s.field.current).field=j.get(s.field.current).gen(t,K())},t.restore=function(){O.ctx.restore();let t=O.ctx.getTransform();Y.x=t.e,Y.y=t.f,s.stroke={...tt.stroke},s.field={...tt.field},s.hatch={...tt.hatch},s.fill={...tt.fill},Q.restore()},t.rotate=function(t=0){Z(),O.ctx.rotate(t)},t.save=function(){Z(),O.ctx.save(),tt.fill={...s.fill},tt.stroke={...s.stroke},tt.hatch={...s.hatch},tt.field={...s.field},Q.save()},t.scale=function(t){Z(),O.ctx.scale(t,t)},t.scaleBrushes=function(t){for(const{param:e}of ve.values())e&&(e.weight*=t,e.vibration*=t,e.spacing*=t)},t.seed=function(t){m=h(t)},t.set=Ee,t.spline=function(t,e=.5){pt(t,e).draw()},t.stroke=function(t,e,n,i){Z(),Me(t,e,n,!0,!1),ke(R(i),!1)},t.strokeStyle=Ae,t.translate=function(t,e){Z(),O.ctx.translate(t,e);let n=O.ctx.getTransform();Y.x=n.e,Y.y=n.f},t.wRand=g},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).brush={});
