const t=Math.sqrt(3),e=.5*(t-1),i=(3-t)/6,n=t=>0|Math.floor(t),r=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function o(t=Math.random){const o=function(t){const e=new Uint8Array(512);for(let t=0;t<256;t++)e[t]=t;for(let i=0;i<255;i++){const n=i+~~(t()*(256-i)),r=e[i];e[i]=e[n],e[n]=r}for(let t=256;t<512;t++)e[t]=e[t-256];return e}(t),s=new Float64Array(o).map((t=>r[t%12*2])),a=new Float64Array(o).map((t=>r[t%12*2+1]));return function(t,r){let c=0,l=0,h=0;const u=(t+r)*e,f=n(t+u),m=n(r+u),g=(f+m)*i,x=t-(f-g),d=r-(m-g);let p,y;x>d?(p=1,y=0):(p=0,y=1);const _=x-p+i,v=d-y+i,b=x-1+2*i,R=d-1+2*i,E=255&f,w=255&m;let A=.5-x*x-d*d;if(A>=0){const t=E+o[w];A*=A,c=A*A*(s[t]*x+a[t]*d)}let S=.5-_*_-v*v;if(S>=0){const t=E+p+o[w+y];S*=S,l=S*S*(s[t]*_+a[t]*v)}let P=.5-b*b-R*R;if(P>=0){const t=E+1+o[w+1];P*=P,h=P*P*(s[t]*b+a[t]*R)}return 70*(c+l+h)}}function s(t,e){let i=new a(t),n=()=>i.next();return n.double=()=>n()+11102230246251565e-32*(2097152*n()|0),n.int32=()=>4294967296*i.next()|0,n.quick=n,n}class a{constructor(t){null==t&&(t=+new Date);let e=4022871197;function i(t){t=String(t);for(let i=0;i<t.length;i++){e+=t.charCodeAt(i);let n=.02519603282416938*e;e=n>>>0,n-=e,n*=e,e=n>>>0,n-=e,e+=4294967296*n}return 2.3283064365386963e-10*(e>>>0)}this.c=1,this.s0=i(" "),this.s1=i(" "),this.s2=i(" "),this.s0-=i(t),this.s0<0&&(this.s0+=1),this.s1-=i(t),this.s1<0&&(this.s1+=1),this.s2-=i(t),this.s2<0&&(this.s2+=1)}next(){let{c:t,s0:e,s1:i,s2:n}=this,r=2091639*e+2.3283064365386963e-10*t;return this.s0=i,this.s1=n,this.s2=r-(this.c=0|r)}copy(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}}let c=s(Math.random());function l(t){c=s(t)}let h=o(s(Math.random()));function u(t){h=o(s(t))}const f=(t=0,e=1)=>t+c()*(e-t);function m(t){return t[~~(c()*t.length)]}function g(t=0,e=1){return Array.isArray(t)?m(t):1===arguments.length?c()*t:f(...arguments)}const x=(t,e)=>~~f(t,e);function d(t=0,e=1){const i=1-c(),n=c();return Math.sqrt(-2*Math.log(i))*b(360*n)*e+t}function p(t){let e=0;const i=[];for(const n in t)e+=t[n],i.push({key:n,cumulative:e});const n=c()*e;for(const t of i)if(n<t.cumulative)return isNaN(t.key)?t.key:parseInt(t.key)}function y(t,e,i,n,r,o=!1){let s=n+(t-e)/(i-e)*(r-n);return o?n<r?_(s,n,r):_(s,r,n):s}function _(t,e,i){return Math.max(Math.min(t,i),e)}function v(t){return(t%=360)<0?t+360:t}function b(t){return S[~~(4*v(t))]}function R(t){return P[~~(4*v(t))]}const E=t=>{let e=180*t/Math.PI%360;return e<0?e+360:e},w=1440,A=2*Math.PI/w,S=new Float32Array(w),P=new Float32Array(w);for(let t=0;t<w;t++){const e=t*A;S[t]=Math.cos(e),P[t]=Math.sin(e)}function T(t,e,i,n,r){let o=b(r),s=R(r);return{x:o*(i-t)+s*(n-e)+t,y:o*(n-e)-s*(i-t)+e}}const I=(t,e,i,n)=>Math.sqrt((i-t)*(i-t)+(n-e)*(n-e)),C=(t,e,i,n)=>E(Math.atan2(-(n-e),i-t));function L(t,e,i,n,r=!1){let o=t.x,s=t.y,a=e.x,c=e.y,l=i.x,h=i.y,u=n.x,f=n.y;if(o===a&&s===c||l===u&&h===f)return!1;let m=a-o,g=c-s,x=u-l,d=f-h,p=d*m-x*g;if(0===p)return!1;let y=(x*(s-h)-d*(o-l))/p,_=(m*(s-h)-g*(o-l))/p;return!(!r&&(_<0||_>1))&&{x:o+y*m,y:s+y*g}}function k(t){return t.map((function(t){return t.slice()}))}const M=()=>{let t,e;const i={};function n(){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8,t.width,t.height),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),i}function r(){let t=n();const i=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),{texture:t,fbo:i}}function o(){return self.navigator&&/Safari/.test(self.navigator.userAgent)&&!/Chrome/.test(self.navigator.userAgent)}function s(){e.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,e.COLOR_BUFFER_BIT,e.NEAREST)}onmessage=async a=>{a.data.canvas?(t=a.data.canvas,function(){e=t.getContext("webgl2",{antialias:!1});const o=(t=>{const e=t.createProgram();for(let[i,n]of[[t.VERTEX_SHADER,"#version 300 es\n#define GLSLIFY 1\nout vec2 p;void main(){vec3 v=vec3(-1);v[gl_VertexID]=3.;gl_Position=vec4(p=v.xy,0,1);}"],[t.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nuniform vec4 u_addColor;uniform bool u_isErase;uniform bool u_isImage;uniform bool u_isBrush;uniform sampler2D u_source;uniform sampler2D u_mask;in vec2 p;out vec4 outColor;const int SPECTRAL_SIZE=38;const float SPECTRAL_GAMMA=2.4;const float SPECTRAL_EPSILON=0.0001;float spectral_uncompand(float x){return(x<0.04045)? x/12.92 : pow((x+0.055)/1.055,SPECTRAL_GAMMA);}float spectral_compand(float x){return(x<0.0031308)? x*12.92 : 1.055*pow(x,1.0/SPECTRAL_GAMMA)-0.055;}vec3 spectral_srgb_to_linear(vec3 srgb){return vec3(spectral_uncompand(srgb[0]),spectral_uncompand(srgb[1]),spectral_uncompand(srgb[2]));}vec3 spectral_linear_to_srgb(vec3 lrgb){return clamp(vec3(spectral_compand(lrgb[0]),spectral_compand(lrgb[1]),spectral_compand(lrgb[2])),0.0,1.0);}void spectral_upsampling(vec3 lrgb,out float w,out float c,out float m,out float y,out float r,out float g,out float b){w=min(lrgb.r,min(lrgb.g,lrgb.b));lrgb-=w;c=min(lrgb.g,lrgb.b);m=min(lrgb.r,lrgb.b);y=min(lrgb.r,lrgb.g);r=min(max(0.,lrgb.r-lrgb.b),max(0.,lrgb.r-lrgb.g));g=min(max(0.,lrgb.g-lrgb.b),max(0.,lrgb.g-lrgb.r));b=min(max(0.,lrgb.b-lrgb.g),max(0.,lrgb.b-lrgb.r));}void spectral_linear_to_reflectance(vec3 lrgb,inout float R[SPECTRAL_SIZE]){float w,c,m,y,r,g,b;spectral_upsampling(lrgb,w,c,m,y,r,g,b);R[0]=max(SPECTRAL_EPSILON,w+c*0.96853629+m*0.51567122+y*0.02055257+r*0.03147571+g*0.49108579+b*0.97901834);R[1]=max(SPECTRAL_EPSILON,w+c*0.96855103+m*0.54015520+y*0.02059936+r*0.03146636+g*0.46944057+b*0.97901649);R[2]=max(SPECTRAL_EPSILON,w+c*0.96859338+m*0.62645502+y*0.02062723+r*0.03140624+g*0.40165780+b*0.97901118);R[3]=max(SPECTRAL_EPSILON,w+c*0.96877345+m*0.75595012+y*0.02073387+r*0.03119611+g*0.24490420+b*0.97892146);R[4]=max(SPECTRAL_EPSILON,w+c*0.96942204+m*0.92826996+y*0.02114202+r*0.03053888+g*0.06826880+b*0.97858555);R[5]=max(SPECTRAL_EPSILON,w+c*0.97143709+m*0.97223624+y*0.02233154+r*0.02856855+g*0.02732883+b*0.97743705);R[6]=max(SPECTRAL_EPSILON,w+c*0.97541862+m*0.98616174+y*0.02556857+r*0.02459485+g*0.01360600+b*0.97428075);R[7]=max(SPECTRAL_EPSILON,w+c*0.98074186+m*0.98955255+y*0.03330189+r*0.01929520+g*0.01000187+b*0.96663223);R[8]=max(SPECTRAL_EPSILON,w+c*0.98580992+m*0.98676237+y*0.05185294+r*0.01423112+g*0.01284127+b*0.94822893);R[9]=max(SPECTRAL_EPSILON,w+c*0.98971194+m*0.97312575+y*0.10087639+r*0.01033111+g*0.02636635+b*0.89937713);R[10]=max(SPECTRAL_EPSILON,w+c*0.99238027+m*0.91944277+y*0.24000413+r*0.00765876+g*0.07058713+b*0.76070164);R[11]=max(SPECTRAL_EPSILON,w+c*0.99409844+m*0.32564851+y*0.53589066+r*0.00593693+g*0.70421692+b*0.46420440);R[12]=max(SPECTRAL_EPSILON,w+c*0.99517200+m*0.13820628+y*0.79874659+r*0.00485616+g*0.85473994+b*0.20123039);R[13]=max(SPECTRAL_EPSILON,w+c*0.99576545+m*0.05015143+y*0.91186529+r*0.00426186+g*0.95081565+b*0.08808402);R[14]=max(SPECTRAL_EPSILON,w+c*0.99593552+m*0.02912336+y*0.95399623+r*0.00409039+g*0.97170370+b*0.04592894);R[15]=max(SPECTRAL_EPSILON,w+c*0.99564041+m*0.02421691+y*0.97137099+r*0.00438375+g*0.97651888+b*0.02860373);R[16]=max(SPECTRAL_EPSILON,w+c*0.99464769+m*0.02660696+y*0.97939505+r*0.00537525+g*0.97429245+b*0.02060067);R[17]=max(SPECTRAL_EPSILON,w+c*0.99229579+m*0.03407586+y*0.98345207+r*0.00772962+g*0.97012917+b*0.01656701);R[18]=max(SPECTRAL_EPSILON,w+c*0.98638762+m*0.04835936+y*0.98553736+r*0.01366120+g*0.94258630+b*0.01451549);R[19]=max(SPECTRAL_EPSILON,w+c*0.96829712+m*0.00011720+y*0.98648905+r*0.03181352+g*0.99989207+b*0.01357964);R[20]=max(SPECTRAL_EPSILON,w+c*0.89228016+m*0.00008554+y*0.98674535+r*0.10791525+g*0.99989891+b*0.01331243);R[21]=max(SPECTRAL_EPSILON,w+c*0.53740239+m*0.85267882+y*0.98657555+r*0.46249516+g*0.13823139+b*0.01347661);R[22]=max(SPECTRAL_EPSILON,w+c*0.15360445+m*0.93188793+y*0.98611877+r*0.84604333+g*0.06968113+b*0.01387181);R[23]=max(SPECTRAL_EPSILON,w+c*0.05705719+m*0.94810268+y*0.98559942+r*0.94275572+g*0.05628787+b*0.01435472);R[24]=max(SPECTRAL_EPSILON,w+c*0.03126539+m*0.94200977+y*0.98507063+r*0.96860996+g*0.06111561+b*0.01479836);R[25]=max(SPECTRAL_EPSILON,w+c*0.02205445+m*0.91478045+y*0.98460039+r*0.97783966+g*0.08987709+b*0.01515250);R[26]=max(SPECTRAL_EPSILON,w+c*0.01802271+m*0.87065445+y*0.98425301+r*0.98187757+g*0.13656016+b*0.01540513);R[27]=max(SPECTRAL_EPSILON,w+c*0.01613460+m*0.78827548+y*0.98403909+r*0.98377315+g*0.22169624+b*0.01557233);R[28]=max(SPECTRAL_EPSILON,w+c*0.01520947+m*0.65738359+y*0.98388535+r*0.98470202+g*0.32176956+b*0.01565710);R[29]=max(SPECTRAL_EPSILON,w+c*0.01475977+m*0.59909403+y*0.98376116+r*0.98515481+g*0.36157329+b*0.01571025);R[30]=max(SPECTRAL_EPSILON,w+c*0.01454263+m*0.56817268+y*0.98368246+r*0.98537114+g*0.48361920+b*0.01571916);R[31]=max(SPECTRAL_EPSILON,w+c*0.01444459+m*0.54031997+y*0.98365023+r*0.98546685+g*0.46488579+b*0.01572133);R[32]=max(SPECTRAL_EPSILON,w+c*0.01439897+m*0.52110241+y*0.98361309+r*0.98550011+g*0.47440306+b*0.01572502);R[33]=max(SPECTRAL_EPSILON,w+c*0.01437620+m*0.51041094+y*0.98357259+r*0.98551031+g*0.48576990+b*0.01571717);R[34]=max(SPECTRAL_EPSILON,w+c*0.01436343+m*0.50526577+y*0.98353856+r*0.98550741+g*0.49267971+b*0.01571905);R[35]=max(SPECTRAL_EPSILON,w+c*0.01435687+m*0.50255080+y*0.98351247+r*0.98551323+g*0.49625685+b*0.01571059);R[36]=max(SPECTRAL_EPSILON,w+c*0.01435370+m*0.50126452+y*0.98350101+r*0.98551563+g*0.49807754+b*0.01569728);R[37]=max(SPECTRAL_EPSILON,w+c*0.01435408+m*0.50083021+y*0.98350852+r*0.98551547+g*0.49889859+b*0.01570020);}vec3 spectral_xyz_to_srgb(vec3 xyz){mat3 XYZ_RGB;XYZ_RGB[0]=vec3(3.24306333,-1.53837619,-0.49893282);XYZ_RGB[1]=vec3(-0.96896309,1.87542451,0.04154303);XYZ_RGB[2]=vec3(0.05568392,-0.20417438,1.05799454);float r=dot(XYZ_RGB[0],xyz);float g=dot(XYZ_RGB[1],xyz);float b=dot(XYZ_RGB[2],xyz);return spectral_linear_to_srgb(vec3(r,g,b));}vec3 spectral_reflectance_to_xyz(float R[SPECTRAL_SIZE]){vec3 xyz=vec3(0.0);xyz+=R[0]*vec3(0.00006469,0.00000184,0.00030502);xyz+=R[1]*vec3(0.00021941,0.00000621,0.00103681);xyz+=R[2]*vec3(0.00112057,0.00003101,0.00531314);xyz+=R[3]*vec3(0.00376661,0.00010475,0.01795439);xyz+=R[4]*vec3(0.01188055,0.00035364,0.05707758);xyz+=R[5]*vec3(0.02328644,0.00095147,0.11365162);xyz+=R[6]*vec3(0.03455942,0.00228226,0.17335873);xyz+=R[7]*vec3(0.03722379,0.00420733,0.19620658);xyz+=R[8]*vec3(0.03241838,0.00668880,0.18608237);xyz+=R[9]*vec3(0.02123321,0.00988840,0.13995048);xyz+=R[10]*vec3(0.01049099,0.01524945,0.08917453);xyz+=R[11]*vec3(0.00329584,0.02141831,0.04789621);xyz+=R[12]*vec3(0.00050704,0.03342293,0.02814563);xyz+=R[13]*vec3(0.00094867,0.05131001,0.01613766);xyz+=R[14]*vec3(0.00627372,0.07040208,0.00775910);xyz+=R[15]*vec3(0.01686462,0.08783871,0.00429615);xyz+=R[16]*vec3(0.02868965,0.09424905,0.00200551);xyz+=R[17]*vec3(0.04267481,0.09795667,0.00086147);xyz+=R[18]*vec3(0.05625475,0.09415219,0.00036904);xyz+=R[19]*vec3(0.06947040,0.08678102,0.00019143);xyz+=R[20]*vec3(0.08305315,0.07885653,0.00014956);xyz+=R[21]*vec3(0.08612610,0.06352670,0.00009231);xyz+=R[22]*vec3(0.09046614,0.05374142,0.00006813);xyz+=R[23]*vec3(0.08500387,0.04264606,0.00002883);xyz+=R[24]*vec3(0.07090667,0.03161735,0.00001577);xyz+=R[25]*vec3(0.05062889,0.02088521,0.00000394);xyz+=R[26]*vec3(0.03547396,0.01386011,0.00000158);xyz+=R[27]*vec3(0.02146821,0.00810264,0.00000000);xyz+=R[28]*vec3(0.01251646,0.00463010,0.00000000);xyz+=R[29]*vec3(0.00680458,0.00249138,0.00000000);xyz+=R[30]*vec3(0.00346457,0.00125930,0.00000000);xyz+=R[31]*vec3(0.00149761,0.00054165,0.00000000);xyz+=R[32]*vec3(0.00076970,0.00027795,0.00000000);xyz+=R[33]*vec3(0.00040737,0.00014711,0.00000000);xyz+=R[34]*vec3(0.00016901,0.00006103,0.00000000);xyz+=R[35]*vec3(0.00009522,0.00003439,0.00000000);xyz+=R[36]*vec3(0.00004903,0.00001771,0.00000000);xyz+=R[37]*vec3(0.00002000,0.00000722,0.00000000);return xyz;}float spectral_linear_to_concentration(float l1,float l2,float t){float t1=l1*pow(1.0-t,2.0);float t2=l2*pow(t,2.0);return t2/(t1+t2);}vec3 spectral_mix(vec3 color1,vec3 color2,float t){vec3 lrgb1=spectral_srgb_to_linear(color1);vec3 lrgb2=spectral_srgb_to_linear(color2);float R1[SPECTRAL_SIZE];float R2[SPECTRAL_SIZE];spectral_linear_to_reflectance(lrgb1,R1);spectral_linear_to_reflectance(lrgb2,R2);float l1=spectral_reflectance_to_xyz(R1)[1];float l2=spectral_reflectance_to_xyz(R2)[1];t=spectral_linear_to_concentration(l1,l2,t);float R[SPECTRAL_SIZE];for(int i=0;i<SPECTRAL_SIZE;i++){float KS=(1.0-t)*(pow(1.0-R1[i],2.0)/(2.0*R1[i]))+t*(pow(1.0-R2[i],2.0)/(2.0*R2[i]));float KM=1.0+KS-sqrt(pow(KS,2.0)+2.0*KS);R[i]=KM;}return spectral_xyz_to_srgb(spectral_reflectance_to_xyz(R));}void main(void){vec2 uv=.5*vec2(p.x,p.y)+.5;vec4 source=texture(u_source,uv);if(u_isImage){vec4 maskColor=texture(u_mask,uv);outColor=maskColor;}else{vec4 maskColor=texture(u_mask,uv);if(maskColor.r>0.){vec4 pigment=vec4(u_addColor.xyz,1.0);float darken_above=0.7;if(maskColor.a>darken_above&&!u_isErase){float blacken=0.5*(maskColor.a-darken_above);pigment=pigment*(1.-blacken)-vec4(0.5)*blacken;}float mixIntensity=maskColor.a;if(!u_isBrush){vec2 texelSize=1.0/vec2(textureSize(u_mask,0));float scaleFactor=15.0;float scaledAlpha=maskColor.a*scaleFactor;float edge=length(vec2(dFdx(scaledAlpha),dFdy(scaledAlpha)));float edgeCenter=smoothstep(0.05,0.35,edge);float blurEdge=0.0;float totalSamples=0.0;for(int i=-2;i<=2;i++){for(int j=-2;j<=2;j++){vec2 offset=vec2(float(i),float(j))*texelSize;vec2 sampleUV=uv+offset;float neighborAlpha=texture(u_mask,sampleUV).a*scaleFactor;float neighborEdge=length(vec2(dFdx(neighborAlpha),dFdy(neighborAlpha)));blurEdge+=smoothstep(0.05,0.35,neighborEdge);totalSamples+=1.0;}}blurEdge/=totalSamples;mixIntensity=clamp(maskColor.a+blurEdge*0.2,0.0,1.0);}vec3 mixedColor=spectral_mix(source.rgb,pigment.rgb,mixIntensity);outColor=vec4(mixedColor,1);}else{outColor=source;}}}"]]){const r=t.createShader(i);t.shaderSource(r,n),t.compileShader(r),t.attachShader(e,r)}return t.linkProgram(e),e})(e);e.useProgram(o),["u_addColor","u_isErase","u_isImage","u_isBrush","u_source","u_mask"].forEach((t=>{i[t]=e.getUniformLocation(o,t)})),i.mask=n(),i.source=r(),i.target=r(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.source.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i.mask),e.uniform1i(i.u_source,0),e.uniform1i(i.u_mask,1)}(),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),e.clearColor(1,1,1,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)):a.data.isBG?(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),e.clearColor(...a.data.color),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)):a.data.mask&&function(t){let n;if(o()){const e=new OffscreenCanvas(t.mask.width,t.mask.height).getContext("2d");e.drawImage(t.mask,0,0),n=e.getImageData(0,0,t.mask.width,t.mask.height)}e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,o()?n:t.mask),t.mask.close(),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.target.fbo),e.uniform1i(i.u_isImage,t.isImage?1:0),e.uniform1i(i.u_isBrush,t.isBrush?1:0),t.isImage||(e.uniform1i(i.u_isImage,!1),e.uniform4f(i.u_addColor,...t.addColor),e.uniform1i(i.u_isErase,!!t.isErase)),e.drawArrays(e.TRIANGLES,0,3),e.bindFramebuffer(e.READ_FRAMEBUFFER,i.target.fbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),s(),t.isLast&&!t.sp&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,i.target.fbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),s())}(a.data)}};Worker.createURL=function(t){const e="function"==typeof t?t.toString():t,i=new Blob(["'use strict';\nself.onmessage="+e],{type:"text/javascript"});return window.URL.createObjectURL(i)},Worker.create=function(t){return new Worker(Worker.createURL(t))};const F={};let z,B,N;function O(t,e){z=t,F[z]||(F[z]={canvas:e}),B=F[z].canvas.width,N=F[z].canvas.height,X=!0,q.load()}let X=!1;const U={},Y=document.createElement("canvas");Y.width=1,Y.height=1;const D=Y.getContext("2d");class W{constructor(t,e,i){if(isNaN(t)){this.hex=this.standardize(t);let e=this.hexToRgb(this.hex);this.r=e.r,this.g=e.g,this.b=e.b}else t=_(t,0,255),e=_(e,0,255),i=_(i,0,255),this.r=t,this.g=isNaN(e)?t:e,this.b=isNaN(i)?t:i,this.hex=this.rgbToHex(this.r,this.g,this.b);this.gl=[this.r/255,this.g/255,this.b/255,1]}rgbToHex(t,e,i){return"#"+(1<<24|t<<16|e<<8|i).toString(16).slice(1)}hexToRgb(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,i,n){return e+e+i+i+n+n}));let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}standardize(t){return D.fillStyle=t,D.fillStyle}}function G(){q.loaded||(function(){if(!X)throw new Error("Canvas system is not ready. Call `load()` first.")}(),q.load())}const q={loaded:!1,isBlending:!1,currentColor:new W("white").gl,load(){if(!F[z].worker){const t=F[z];t.mask=new OffscreenCanvas(B,N),t.glMask=new OffscreenCanvas(B,N),t.ctx=t.mask.getContext("2d"),t.gl=t.glMask.getContext("webgl2"),t.ctx.lineWidth=0,t.offscreen=F[z].canvas.transferControlToOffscreen(),t.worker=Worker.create(M),t.worker.postMessage("init"),t.worker.postMessage({canvas:t.offscreen},[t.offscreen])}Object.assign(this,F[z])},blend(t=!1,e=!1,i=!1,n=!1){G(),!this.isBlending&&t&&(this.currentColor=t.gl,this.isBlending=!0);const r=t?t.gl:this.currentColor;if(e||i||r.toString()!==this.currentColor.toString()){const r=i||this.isBrush?this.glMask.transferToImageBitmap():this.mask.transferToImageBitmap();this.worker.postMessage({addColor:this.currentColor,mask:r,isLast:e,isErase:this.isErase,isImage:Boolean(i),sp:n,isBrush:this.isBrush},[r]),this.isErase=!1,this.isBrush=!1,e||(this.currentColor=t.gl),e&&!n&&(this.isBlending=!1)}}};let Z=new W("white");function H(t,e,i){G(),Z=new W(...arguments),q.worker.postMessage({color:Z.gl,isBG:!0})}function V(t,e=0,i=0,n=t.width,r=t.height){G(),"[object ImageBitmap]"===Object.prototype.toString.call(t)&&0===e||(q.ctx.drawImage(t,e,i,n,r),t=q.mask.transferToImageBitmap()),q.blend(!1,!1,t)}const j={x:0,y:0};function $(t,e){tt(),q.ctx.translate(t,e);let i=q.ctx.getTransform();j.x=i.e,j.y=i.f}function K(t=0){tt(),q.ctx.rotate(t)}function J(t){tt(),q.ctx.scale(t,t)}let Q=!1;function tt(){Q||(G(),it=.01*B,nt=-.5*B,rt=-.5*N,ot=Math.round(2*B/it),st=Math.round(2*N/it),ft("hand",(function(t,e){const i=f(.2,.8),n=x(5,10),r=.1*t;for(let o=0;o<ot;o++){const s=.1*o+r;for(let a=0;a<st;a++){const c=n*R(i*a*o+x(15,25)),l=h(s,.1*a+r);e[o][a]=.5*c*b(t)+l*n*.5}}return e})),ft("seabed",(function(t,e){const i=f(.4,.8),n=x(18,26);for(let r=0;r<ot;r++)for(let o=0;o<st;o++){const s=n*R(i*o*r+x(15,20));e[r][o]=1.1*s*b(t)}return e})),gt.genField(),Q=!0)}class et{constructor(t,e){this.update(t,e),this.plotted=0}update(t,e){this.x=t,this.y=e,this.column_index=et.getColIndex(t),this.row_index=et.getRowIndex(e)}reset(){this.plotted=0}isIn(){return U.field.isActive?et.isIn(this.column_index,this.row_index):this.isInCanvas(this.x,this.y)}isInCanvas(){const t=B,e=N,i=this.x+j.x,n=this.y+j.y;return i>=-.3*t&&i<=1.3*t&&n>=-.3*e&&n<=1.3*e}angle(){return this.isIn()&&U.field.isActive?at.get(U.field.current).field[this.column_index][this.row_index]:0}moveTo(t,e,i,n=!0){if(!this.isIn())return void(this.plotted+=i);let r,o;for(let s=0;s<t/i;s++){if(n){const t=this.angle();r=b(t-e),o=R(t-e)}else r=b(-e),o=R(-e);const t=i*r,s=i*o;this.plotted+=i,this.update(this.x+t,this.y+s)}}plotTo(t,e,i,n){if(!this.isIn())return void(this.plotted+=i/n);const r=1/n;for(let n=0;n<e/i;n++){const e=this.angle(),n=t.angle(this.plotted),o=i*b(e-n),s=i*R(e-n);this.plotted+=i*r,this.update(this.x+o,this.y+s)}}static getRowIndex(t,e=1){const i=t+j.y-rt;return Math.round(i/it/e)}static getColIndex(t,e=1){const i=t+j.x-nt;return Math.round(i/it/e)}static isIn(t,e){return t>=0&&e>=0&&t<ot&&e<st}}U.field={isActive:!1,current:null};let it,nt,rt,ot,st,at=new Map;function ct(t=0){at.get(U.field.current).field=at.get(U.field.current).gen(t,lt())}function lt(t=1){return new Array(ot/t).fill(null).map((()=>new Float32Array(st/t)))}function ht(t){if(!at.has(t))throw new Error(`Field "${name}" does not exist.`);U.field.isActive=!0,U.field.current=t}function ut(){U.field.isActive=!1}function ft(t,e){at.set(t,{gen:e}),at.get(t).field=at.get(t).gen(0,lt())}function mt(){return Array.from(at.keys())}const gt={d:4,genField(){this.field=lt(this.d),this.fieldTemp=lt(this.d)},get(t,e,i=!1){const n=et.getColIndex(t,this.d),r=et.getRowIndex(e,this.d),o=this.field?.[n]?.[r]??0;if(i){const t=Math.max(o,i),e=.75*(this.fieldTemp[n]?.[r]??0);return this.fieldTemp[n][r]=Math.max(t,e),t}return o},update(){for(let t=0;t<ot/this.d;t++)for(let e=0;e<st/this.d;e++)this.field[t][e]=this.fieldTemp[t][e]},save(){this.A=k(this.field),this.B=k(this.fieldTemp)},restore(){this.field=this.A,this.fieldTemp=this.B}};let xt={};function dt(){tt(),q.ctx.save(),xt.fill={...U.fill},xt.stroke={...U.stroke},xt.hatch={...U.hatch},xt.field={...U.field},gt.save()}function pt(){q.ctx.restore();let t=q.ctx.getTransform();j.x=t.e,j.y=t.f,U.stroke={...xt.stroke},U.field={...xt.field},U.hatch={...xt.hatch},U.fill={...xt.fill},gt.restore()}function yt(t){q.ctx.beginPath(),t.forEach(((t,e)=>{0===e?q.ctx.moveTo(t.x,t.y):q.ctx.lineTo(t.x,t.y)})),q.ctx.closePath()}function _t(t,e,i){const n=2*Math.PI,r=i/2;q.ctx.moveTo(t+r,e),q.ctx.arc(t,e,r,0,n)}const vt={isActive:!1,c:null,a:255};function bt(t=_bg_Color,e=255){vt.isActive=!0,vt.c=new W(t),vt.a=e}function Rt(){vt.isActive=!1}function Et(t){Mix.blend(vt.c),Mix.isErase=!0,Mix.ctx.save(),Mix.ctx.fillStyle="rgb(255 0 0 / "+vt.a+"%)",yt(t),Mix.ctx.fill(),Mix.ctx.restore()}class wt{constructor(t,e=!1){this.a=t,this.vertices=e?t:t.map((([t,e])=>({x:t,y:e}))),this.sides=this.vertices.map(((t,e,i)=>[t,i[(e+1)%i.length]])),this._intersectionCache={}}intersect(t){const e=`${t.point1.x},${t.point1.y}-${t.point2.x},${t.point2.y}`;if(this._intersectionCache[e])return this._intersectionCache[e];const i=[];for(const[e,n]of this.sides){const r=L(t.point1,t.point2,e,n);r&&i.push(r)}return this._intersectionCache[e]=i,i}erase(){vt.isActive&&Et(this.vertices)}show(){U.draw&&this.draw(),U.hatch&&this.hatch(),U.fill&&this.fill(),this.erase()}}class At{constructor(t){this.segments=[],this.angles=[],this.pres=[],this.type=t,this.dir=0,this.calcIndex(0),this.pol=!1}addSegment(t=0,e=0,i=1,n=!1){this.angles.length>0&&this.angles.pop(),t=n?(t%360+360)%360:E(t),this.angles.push(t,t),this.pres.push(i),this.segments.push(e),this.length=this.segments.reduce(((t,e)=>t+e),0)}endPlot(t=0,e=1,i=!1){t=i?(t%360+360)%360:E(t),this.angles[this.angles.length-1]=t,this.pres.push(e)}rotate(t){this.dir=E(t)}pressure(t){return t>this.length?this.pres[this.pres.length-1]:this.curving(this.pres,t)}angle(t){return t>this.length?this.angles[this.angles.length-1]:(this.calcIndex(t),"curve"===this.type?this.curving(this.angles,t)+this.dir:this.angles[this.index]+this.dir)}curving(t,e){let i=t[this.index],n=t[this.index+1]??i;return Math.abs(n-i)>180&&(n>i?n=-(360-n):i=-(360-i)),y(e-this.suma,0,this.segments[this.index],i,n,!0)}calcIndex(t){this.index=-1,this.suma=0;let e=0;for(;e<=t;)this.suma=e,e+=this.segments[this.index+1],this.index++;return this.index}genPol(t,e,i=1,n){tt();const r=.5,o=[],s=Math.round(this.length/r),a=new et(t,e);let c=0,l=0;for(let t=0;t<s;t++){a.plotTo(this,r,r,1);const t=this.calcIndex(a.plotted);c+=r,(c>=Math.max(this.segments[t]*n*f(.7,1.3),10)||t>=l)&&a.x&&(o.push([a.x,a.y]),c=0,t>=l&&l++)}return new wt(o)}erase(t,e,i){vt.isActive&&(this.origin&&([t,e,i]=[...this.origin,1]),this.pol=this.genPol(t,e,i,.15),Et(this.pol.vertices))}show(t,e,i=1){U.stroke&&this.draw(t,e,i),U.hatch&&this.hatch(t,e,i),U.fill&&this.fill(t,e,i),this.erase(t,e,i)}}function St(t){new wt(t).show()}function Pt(t,e,i,n,r="corner"){"center"===r&&(t-=i/2,e-=n/2),Bt(0),Nt(t,e),Ot(t+i,e),Ot(t+i,e+n),Ot(t,e+n),Xt(),Ut()}function Tt(t,e,i,n=!1){const r=new At("curve"),o=Math.PI*i,s=f(0,360),a=n?()=>1+.2*f():()=>1;for(let t=0;t<4;t++){const e=-90*t+s;r.addSegment(e*a(),o/2*a(),1,!0)}if(n){const t=x(-5,5);r.addSegment(s,Math.abs(t)*(Math.PI/180)*i,1,!0),r.endPlot(t+s,1,!0)}else r.endPlot(s,1,!0);const c=t-i*R(s),l=e-i*b(-s);r.show(c,l,1)}function It(t,e,i,n,r){const o=new At("curve"),s=270-E(n),a=270-E(r),c=E(r-n),l=Math.PI*i*c/180;o.addSegment(s,l,1,!0),o.endPlot(a,1,!0);const h=t+i*b(-s-90),u=e+i*R(-s-90);o.draw(h,u,1)}let Ct,Lt,kt,Mt,Ft;class zt{constructor(){this.isClosed=!1,this.curvature=kt,this.vert=[]}vertex(t,e,i){this.vert.push([t,e,i])}show(){qt(this.vert,this.curvature,this.isClosed).show()}}function Bt(t=0){kt=_(t,0,1),Ct=[]}function Nt(t,e,i=1){Lt=new zt,Ct.push(Lt),Lt.vertex(t,e,i)}function Ot(t,e,i=1){Lt.vertex(t,e,i)}function Xt(){Lt.vertex(...Lt.vert[0]),Lt.isClosed=!0}function Ut(){for(let t of Ct)t.show();Ct=!1}function Yt(t,e,i){Ft=[e,i],Mt=new At(t)}function Dt(t,e,i){Mt.addSegment(t,e,i)}function Wt(t,e){Mt.endPlot(t,e),Mt.draw(Ft[0],Ft[1],1),Mt=!1}function Gt(t,e=.5){qt(t,e).draw()}function qt(t,e=.5,i=!1){const n=new At(0===e?"segments":"curve"),r=2*Math.PI;if(i&&0!==e&&t.push(t[1]),t&&t.length>0){let o,s,a,c=0;for(let l=0;l<t.length-1;l++)if(e>0&&l<t.length-2){const h=t[l],u=t[l+1],f=t[l+2],m=I(h[0],h[1],u[0],u[1]),g=I(u[0],u[1],f[0],f[1]),x=C(h[0],h[1],u[0],u[1]),d=C(u[0],u[1],f[0],f[1]),p=e*Math.min(m,g,.5*Math.min(m,g)),y=Math.max(m,g),_=m-p,v=g-p;if(Math.floor(x)===Math.floor(d)){const e=i&&0===l?0:m-c,r=i?0===l?0:g-a:g;n.addSegment(x,e,h[2],!0),l===t.length-3&&n.addSegment(d,r,u[2],!0),c=0,0===l&&(o=m,a=p,s=t[1],c=0)}else{const e={x:u[0]-p*b(-x),y:u[1]-p*R(-x)},f={x:e.x+y*b(90-x),y:e.y+y*R(90-x)},m={x:u[0]+p*b(-d),y:u[1]+p*R(-d)},g=L(e,f,m,{x:m.x+y*b(90-d),y:m.y+y*R(90-d)},!0),E=I(e.x,e.y,g.x,g.y),w=I(e.x,e.y,m.x,m.y)/2,A=r*E*(2*Math.asin(w/E)*(180/Math.PI))/360,S=i&&0===l?0:_-c,P=l===t.length-3?i?o-p:v:0;n.addSegment(x,S,h[2],!0),n.addSegment(x,isNaN(A)?0:A,h[2],!0),n.addSegment(d,P,u[2],!0),c=p,0===l&&(o=_,a=p,s=[e.x,e.y])}l===t.length-3&&n.endPlot(d,u[2],!0)}else if(0===e){const e=t[l],i=t[l+1],r=I(e[0],e[1],i[0],i[1]),o=C(e[0],e[1],i[0],i[1]);n.addSegment(o,r,i[2],!0),l===t.length-2&&n.endPlot(o,1,!0)}n.origin=i&&0!==e?s:t[0]}return n}let Zt,Ht=0,Vt=!0,jt=30,$t=0;function Kt(t=!1){t&&(Zt=t),Vt=!0,requestAnimationFrame(te)}function Jt(){Vt=!1}let Qt=t=>(t&&(jt=t),jt);function te(t){Vt&&(t>Ht+1e3/Qt()||0===t)&&(Ht=t,$t++,Zt&&Zt(),ee()),requestAnimationFrame(te)}function ee(){q.blend(!1,!0)}let ie,ne,re=!1;function oe(){re||(G(),ie=q.gl,ne=new Float32Array([2/B,0,0,0,0,-2/N,0,0,0,0,1,0,-1,1,0,1]),function(){const t=((t,e,i)=>{const n=t.createProgram();for(let[r,o]of[[t.VERTEX_SHADER,e],[t.FRAGMENT_SHADER,i]]){const e=t.createShader(r);t.shaderSource(e,o),t.compileShader(e),t.attachShader(n,e)}return t.linkProgram(n),n})(ie,se,ae);ie.useProgram(t),ie.enable(ie.BLEND),ie.blendFunc(ie.ONE_MINUS_DST_ALPHA,ie.ONE),["a_position","a_radius","a_alpha"].forEach((e=>ce[e]=ie.getAttribLocation(t,e))),["u_matrix","u_drawSquare"].forEach((e=>le[e]=ie.getUniformLocation(t,e)))}(),re=!0)}const se="#version 300 es\nin vec2 a_position;in float a_radius,a_alpha;uniform mat4 u_matrix;out float v_alpha;void main(){gl_Position=u_matrix*vec4(a_position,0,1);v_alpha=a_alpha;gl_PointSize=a_radius*2.;}",ae="#version 300 es\nprecision highp float;uniform bool u_drawSquare;in float v_alpha;out vec4 outColor;void main(){if(u_drawSquare)outColor=vec4(vec3(1,0,0)*v_alpha,v_alpha);else{vec2 v=gl_PointCoord-vec2(.5);float e=length(v);if(e>.5)discard;outColor=vec4(vec3(1,0,0)*v_alpha,v_alpha*(1.-smoothstep(.45,.5,e)));}}",ce={},le={};function he(){const t=4*Float32Array.BYTES_PER_ELEMENT,e=new Float32Array(4*ue.length);ue.forEach(((t,i)=>{const n=4*i;e.set([t.x,t.y,t.radius,t.alpha],n)})),ue=[];const{vao:i,buf:n}=function(t,e,i){const n=ie.createVertexArray();ie.bindVertexArray(n);const r=ie.createBuffer();return ie.bindBuffer(ie.ARRAY_BUFFER,r),ie.bufferData(ie.ARRAY_BUFFER,t,ie.STATIC_DRAW),e.forEach((t=>{const e=ce[t.name];ie.enableVertexAttribArray(e),ie.vertexAttribPointer(e,t.size,ie.FLOAT,!1,i,t.offset)})),{vao:n,buf:r}}(e,[{name:"a_position",size:2,offset:0},{name:"a_radius",size:1,offset:2*Float32Array.BYTES_PER_ELEMENT},{name:"a_alpha",size:1,offset:3*Float32Array.BYTES_PER_ELEMENT}],t);ie.uniformMatrix4fv(le.u_matrix,!1,ne),ie.uniform1i(le.u_drawSquare,fe?1:0),ie.bindVertexArray(i),ie.drawArrays(ie.POINTS,0,e.length/4),ie.bindVertexArray(null),ie.deleteBuffer(n),ie.deleteVertexArray(i)}let ue=[],fe=!1;function me(t,e,i,n){oe();const r=i/2/1.2;ue.push({x:t+j.x,y:e+j.y,radius:r,alpha:n/100}),fe=!0}const ge=2*Math.PI;U.stroke={color:new W("black"),weight:1,clipWindow:null,type:"HB",isActive:!1};let xe,de,pe,ye,_e,ve=new Map;function be(){return{...U.stroke}}function Re(t){U.stroke={...t}}function Ee(t,e){e.type=["marker","custom","image","spray"].includes(e.type)?e.type:"default",ve.set(t,{param:e,colors:[],buffers:[]})}function we(){return[...ve.keys()]}function Ae(t){for(const{param:e}of ve.values())e&&(e.weight*=t,e.vibration*=t,e.spacing*=t)}function Se(t){ve.has(t)&&(U.stroke.type=t)}function Pe(t,e,i){U.stroke.color=new W(...arguments),U.stroke.isActive=!0}function Te(t){U.stroke.weight=t}function Ie(t,e,i=1){Se(t),Pe(e),Te(i)}function Ce(){U.stroke.isActive=!1}function Le(t){U.stroke.clipWindow=t}function ke(){U.stroke.clipWindow=null}const Me={};function Fe(t,e,i,n,r){xe=new et(t,e),de=i,pe=n,ye=r,ye&&ye.calcIndex(0)}const ze=[];function Be(t,e){e||(_e=t),function(){Me.seed=99999*f();const{param:t}=ve.get(U.stroke.type)??{};if(!t)return;Me.p=t;const{pressure:e}=t;Me.a="custom"!==e.type?f(-1,1):0,Me.b="custom"!==e.type?f(1,1.5):0,Me.cp="custom"!==e.type?f(3,3.5):f(-.2,.2),[Me.min,Me.max]=e.min_max,oe(),q.blend(U.stroke.color),q.isBrush=!0,Me.alpha=Ye(),Ge()}();const i=function(){const{param:t}=ve.get(U.stroke.type)??{};return t?"default"===t.type||"spray"===t.type?t.spacing/U.stroke.weight:t.spacing:1}(),n=Math.round(de*(e?t:1)/i);for(let r=0;r<n;r++)ze.length<2*n&&ze.push(d()),Ne(),e?xe.plotTo(ye,i,i,t,r<10):xe.moveTo(i,t,i,pe);he(U.stroke.color),Ge()}function Ne(t=!1){if(!De())return;let e=t||Oe();switch(e*=1-.2*h(.01*xe.plotted+Me.seed,1)-.2*h(.003*xe.x,.003*xe.y),Me.p.type){case"spray":!function(t){const e=U.stroke.weight*Me.p.vibration*t+U.stroke.weight*m(ze)*Me.p.vibration/3,i=U.stroke.weight*f(.9,1.1),n=Math.ceil(Me.p.quality/t);for(let t=0;t<n;t++){const t=f(.9,1.1),n=t*e*f(-1,1),r=f(-1,1),o=Math.sqrt((t*e)**2-n**2);me(xe.x+n,xe.y+r*o,i,Me.alpha)}}(e);break;case"marker":We(e);break;case"custom":case"image":!function(t,e,i=!0){q.ctx.save();const n=i?U.stroke.weight*Me.p.vibration:0,r=i?n*f(-1,1):0,o=i?n*f(-1,1):0;q.ctx.translate(xe.x+r,xe.y+o),function(t){q.ctx.scale(t,t);let e=0;"random"===Me.p.rotate?e=x(0,ge):"natural"===Me.p.rotate&&(e=(ye?-ye.angle(xe.plotted):-_e)+(pe?xe.angle():0),e=e*Math.PI/180),q.ctx.rotate(e)}(U.stroke.weight*t),Me.p.tip(q.ctx),q.ctx.restore()}(e);break;default:!function(t){const e=U.stroke.weight*Me.p.vibration*(Me.p.definition+(1-Me.p.definition)*m(ze)*Ue(.5,.9,5,.2,1.2)/t);f(0,Me.p.quality*t)>.4&&me(xe.x+.7*e*f(-1,1),xe.y+e*f(-1,1),t*Me.p.weight*f(.85,1.15),Me.alpha)}(e)}}function Oe(){return ye?Xe()*ye.pressure(xe.plotted):Xe()}function Xe(){return"custom"===Me.p.pressure.type?y(Me.p.pressure.curve(xe.plotted/de)+Me.cp,0,1,Me.min,Me.max,!0):Ue()}function Ue(t=.5+Me.p.pressure.curve[0]*Me.a,e=1-Me.p.pressure.curve[1]*Me.b,i=Me.cp,n=Me.min,r=Me.max){return y(1/(1+Math.pow(Math.abs((xe.plotted-t*de)/(e*de/2)),2*i)),0,1,n,r)}function Ye(){return["default","spray"].includes(Me.p.type)?Me.p.opacity:Me.p.opacity/U.stroke.weight}function De(){if(U.stroke.clipWindow)return xe.x>=U.stroke.clipWindow[0]&&xe.x<=U.stroke.clipWindow[2]&&xe.y>=U.stroke.clipWindow[1]&&xe.y<=U.stroke.clipWindow[3];{let t=B,e=N,i=.05*B,n=xe.x+j.x,r=xe.y+j.y;return n>=-i&&n<=t+i&&r>=-i&&r<=e+i}}function We(t,e=!0,i=Me.alpha){const n=e?U.stroke.weight*Me.p.vibration:0,r=e?n*f(-1,1):0,o=e?n*f(-1,1):0;!function(t,e,i,n){oe();const r=i/2;ue.push({x:t+j.x,y:e+j.y,radius:r,alpha:n/100}),fe=!1}(xe.x+r,xe.y+o,U.stroke.weight*Me.p.weight*t,i)}function Ge(){if(De()){let t=Oe(),e=Ye();if("marker"===Me.p.type){for(let i=1;i<10;i++)We(t*i/10,!1,5*e);he(U.stroke.color)}else if("custom"===Me.p.type||"image"===Me.p.type)for(let i=1;i<5;i++)q.ctx.beginPath(),Me.drawCustomOrImage(t*i/5,e,!1),q.ctx.fill()}}function qe(t,e,i,n){tt();let r=I(t,e,i,n);0!=r&&(Fe(t,e,r,!0,!1),Be(C(t,e,i,n),!1))}function Ze(t,e,i,n){tt(),Fe(t,e,i,!0,!1),Be(E(n),!1)}const He=["weight","vibration","definition","quality","opacity","spacing","pressure","type","tip","rotate"],Ve=[["pen",[.35,.12,.5,8,88,.3,{curve:[.15,.2],min_max:[1.4,.9]}]],["rotring",[.2,.05,.5,30,115,.15,{curve:[.35,.2],min_max:[1.3,.9]}]],["2B",[.35,.6,.1,8,140,.2,{curve:[.15,.2],min_max:[1.5,1]}]],["HB",[.3,.5,.4,4,130,.25,{curve:[.15,.2],min_max:[1.2,.9]}]],["2H",[.2,.4,.3,2,60,.2,{curve:[.15,.2],min_max:[1.2,.9]}]],["cpencil",[.4,.55,.8,7,70,.15,{curve:[.15,.2],min_max:[.95,1.2]}]],["charcoal",[.35,1.5,.65,300,60,.06,{curve:[.15,.2],min_max:[1.3,.9]}]],["crayon",[.25,2,.8,300,60,.06,{curve:[.35,.2],min_max:[.9,1.1]}]],["spray",[.2,12,15,40,35,.65,{curve:[0,.1],min_max:[1,1]},"spray"]],["marker",[2.5,.12,null,null,.4,.04,{curve:[.35,.25],min_max:[1.5,1]},"marker"]]];for(let t of Ve){let e={};for(let i=0;i<t[1].length;i++)e[He[i]]=t[1][i];Ee(t[0],e)}function je(){return{...U.hatch}}function $e(t=5,e=45,i={rand:!1,continuous:!1,gradient:!1}){let n=U.hatch;n.isActive=!0,n.dist=t,n.angle=e,n.options=i}function Ke(t,e="black",i=1){U.hatch.hBrush={brush:t,color:e,weight:i}}function Je(){U.hatch.isActive=!1,U.hatch.hBrush=!1}function Qe(t){let e=U.hatch.dist,i=E(U.hatch.angle)%180,n=U.hatch.options,r=be();U.hatch.hBrush&&Ie(...Object.values(U.hatch.hBrush)),Array.isArray(t)||(t=[t]);const o=function(t){let e={minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};for(let i of t){const t=ti(i);e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}return e}(t);let s=new wt([[o.minX,o.minY],[o.maxX,o.minY],[o.maxX,o.maxY],[o.minX,o.maxY]]),a=i<=90&&i>=0?o.minY:o.maxY,c=n.gradient?y(n.gradient,0,1,1,1.1,!0):1,l=[],h=0,u=e,m=t=>({point1:{x:o.minX+u*t*b(90-i),y:a+u*t*R(90-i)},point2:{x:o.minX+u*t*b(90-i)+b(-i),y:a+u*t*R(90-i)+R(-i)}});for(;s.intersect(m(h)).length>0;){let e=[];for(let i of t)e.push(i.intersect(m(h)));l[h]=e.flat().sort(((t,e)=>t.x===e.x?t.y-e.y:t.x-e.x)),u*=c,h++}let g=l.filter((t=>void 0!==t[0])),x=n.rand||0;for(let t=0;t<g.length;t++){let i=g[t],r=t>0&&n.continuous;for(let n=0;n<i.length-1;n+=2)0!==x&&(i[n].x+=x*e*f(-10,10),i[n].y+=x*e*f(-10,10),i[n+1].x+=x*e*f(-10,10),i[n+1].y+=x*e*f(-10,10)),qe(i[n].x,i[n].y,i[n+1].x,i[n+1].y),r&&qe(g[t-1][1].x,g[t-1][1].y,i[n].x,i[n].y)}Re(r)}function ti(t){if(t._boundingBox)return t._boundingBox;let e=Infinity,i=Infinity,n=-Infinity,r=-Infinity;for(let o=0;o<t.a.length;o++){const[s,a]=t.a[o];s<e&&(e=s),s>n&&(n=s),a<i&&(i=a),a>r&&(r=a)}return t._boundingBox={minX:e,minY:i,maxX:n,maxY:r},t._boundingBox}function ei(){return{...U.fill}}function ii(t,e,i,n){U.fill.opacity=(arguments.length<4?e:n)||60,U.fill.color=arguments.length<3?new W(t):new W(t,e,i),U.fill.isActive=!0}function ni(t,e="out"){U.fill.bleed_strength=_(t,0,1),U.fill.direction=e}function ri(t=.4,e=.4){U.fill.texture_strength=_(t,0,1),U.fill.border_strength=_(e,0,1)}function oi(){U.fill.isActive=!1}let si;wt.prototype.draw=function(t=!1,e,i){let n=be();if(t&&Ie(t,e,i),n.isActive)for(let t of this.sides)qe(t[0].x,t[0].y,t[1].x,t[1].y);Re(n)},At.prototype.draw=function(t,e,i){be().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),function(t,e,i,n){tt(),Fe(e,i,t.length,!0,t),Be(n,!0)}(this,t,e,i))},U.hatch={isActive:!1,dist:5,angle:45,options:{},hBrush:!1},wt.prototype.hatch=function(t=!1,e,i){let n=je();t&&$e(t,e,i),n.isActive&&Qe(this),function(t){U.hatch={...t}}(n)},At.prototype.hatch=function(t,e,i){je().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),this.pol=this.genPol(t,e,i,.25),this.pol.hatch())},U.fill={color:new W("#002185"),opacity:60,bleed_strength:.07,texture_strength:.8,border_strength:.5,direction:"out",isActive:!1};const ai=[],ci=[];class li{constructor(t,e,i,n,r,o,s){if(this.v=t,this.dir=n,this.m=e,this.midP=i,this.sizeX=o,this.sizeY=s,r){this.sizeX=-Infinity,this.sizeY=-Infinity;for(let t of this.v)this.sizeX=Math.max(Math.abs(this.midP.x-t.x),this.sizeX),this.sizeY=Math.max(Math.abs(this.midP.y-t.y),this.sizeY);for(let t=0;t<this.v.length;t++){const e=this.v[t],i=this.v[(t+1)%this.v.length],n={x:i.x-e.x,y:i.y-e.y},r=T(0,0,n.x,n.y,90);let o={point1:{x:e.x+n.x/2,y:e.y+n.y/2},point2:{x:e.x+n.x/2+r.x,y:e.y+n.y/2+r.y}};const s=(t,e,i)=>(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)>.01;let a=0;for(let t of si.intersect(o))s(e,i,t)&&a++;this.dir[t]=a%2==0}}}trim(t=1){let e=[...this.v],i=[...this.m],n=[...this.dir];if(this.v.length>8&&t>=0&&1!==t){const r=~~((1-t)*this.v.length),o=~~(this.v.length/2-r/2);e.splice(o,r),i.splice(o,r),n.splice(o,r)}return{v:e,m:i,dir:n}}grow(t=1){const{v:e,m:i,dir:n}=this.trim(t),r=e.length,o=2*r,s=new Array(o),a=new Array(o),c=new Array(o),l="out"===U.fill.direction?-90:90;let h=0,u=999===t?f(.2,.6):U.fill.bleed_strength/1.7;for(let o=0;o<r;o++){ai.length<1.5*r&&(ai.push(d(.5,.2)),ci.push(d(0,.02)));const g=e[o],x=o+1<r?e[o+1]:e[0];t<997&&(u=gt.get(g.x,g.y,i[o]));const p=(n[o]?l:-l)+5*f(-1,1),y=x.x-g.x,_=x.y-g.y,{x:v,y:b}=T(0,0,y,_,p),R=f(.35,.65),E=m(ai)*f(.65,1.35)*u;s[h]=g,a[h]=i[o],c[h++]=n[o],s[h]={x:g.x+y*R+v*E,y:g.y+_*R+b*E},a[h]=i[o]+m(ci),c[h++]=n[o]}return new li(s,a,this.midP,c,!1,this.sizeX,this.sizeY)}fill(t,e,i){const n=3*i,r=e*(1+i/2);q.blend(t),q.ctx.save(),q.ctx.fillStyle="rgb(255 0 0 / "+2*r+"%)",q.ctx.strokeStyle="rgb(255 0 0 / "+.01*U.fill.border_strength+")";const o=Math.max(this.sizeX,this.sizeY);q.ctx.lineCap="round";const s=f(.15,.7);let a,c=this.grow();for(let i=0;i<24;i++){i%4==0&&(c=c.grow()),a=[c.grow(1-.0125*i),c.grow(.7-.0125*i),c.grow(.4-.0125*i)];for(let t of a)t.grow(997).grow().layer(i,o);c.grow(s).grow(999).layer(i,o),i%6!=0&&23!==i||(0!==n&&c.erase(4*n,e),q.blend(t,!0,!1,!0))}gt.update(),q.ctx.restore()}layer(t,e){q.ctx.lineWidth=y(t,0,24,e/25,e/30,!0),yt(this.v),q.ctx.fill(),q.ctx.stroke()}erase(t,e){q.ctx.save();let i=f(60,80)*y(t,0,1,2,3);const n=this.sizeX/1.8,r=this.sizeY/1.8,o=Math.min(this.sizeX,this.sizeY)*(1.4-U.fill.bleed_strength),s=.05*o,a=.4*o,c=this.midP.x,l=this.midP.y;q.ctx.globalCompositeOperation="destination-out";let h=(5-y(e,80,100,.3,1,!0))*t;q.ctx.fillStyle="rgb(255 0 0 / "+h/255+")",q.ctx.lineWidth=0;for(let t=0;t<i;t++){const e=c+d(0,n),i=l+d(0,r),o=f(s,a);q.ctx.beginPath(),_t(e,i,o),t%4!=0&&q.ctx.fill()}q.ctx.globalCompositeOperation="source-over",q.ctx.restore()}}wt.prototype.fill=function(t=!1,e,i,n,r,o){let s=ei();t&&(ii(t,e),ni(i,o),ri(n,r)),s.isActive&&(tt(),function(t){si=t;let e=[...t.vertices];const i=e.length,n=.25*i*p({1:5,2:10,3:60}),r=U.fill.bleed_strength;let o=e.map(((t,e)=>{let i=f(.85,1.2)*r;return e>n?i:.2*i}));const s=x(0,i);e=[...e.slice(s),...e.slice(0,s)];const a=function(t){const e=(t=[...t])[0],i=t[t.length-1];e.x===i.x&&e.y===i.y||t.push(e);let n=0,r=0,o=0,s=t.length;for(let i=0,a=s-1;i<s;a=i++){const s=t[i],c=t[a],l=(s.y-e.y)*(c.x-e.x)-(c.y-e.y)*(s.x-e.x);n+=l,r+=(s.x+c.x-2*e.x)*l,o+=(s.y+c.y-2*e.y)*l}const a=3*n;return{x:r/a+e.x,y:o/a+e.y}}(e);new li(e,o,a,[],!0).fill(U.fill.color,y(U.fill.opacity,0,100,0,1,!0),U.fill.texture_strength)}(this)),function(t){U.fill={...t}}(s)},At.prototype.fill=function(t,e,i){ei().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),this.pol=this.genPol(t,e,i,y(U.fill.bleed_strength,0,.6,.2,.45)),this.pol.fill())};export{W as Color,At as Plot,wt as Polygon,et as Position,Ee as add,ft as addField,It as arc,H as background,Bt as beginPath,Yt as beginStroke,we as box,Tt as circle,Le as clip,Xt as closePath,ee as draw,V as drawImage,Ut as endPath,Wt as endStroke,bt as erase,ht as field,ni as fillBleed,ii as fillStyle,ri as fillTexture,$t as frameCount,Qt as frameRate,$e as hatch,Qe as hatchArray,Ke as hatchStyle,qe as line,Ot as lineTo,Te as lineWidth,mt as listFields,O as load,Kt as loop,Dt as move,Nt as moveTo,ke as noClip,Rt as noErase,ut as noField,oi as noFill,Je as noHatch,Jt as noLoop,Ce as noStroke,h as noise,u as noiseSeed,Se as pick,St as polygon,g as random,Pt as rect,ct as refreshField,pt as restore,K as rotate,dt as save,J as scale,Ae as scaleBrushes,l as seed,Ie as set,Gt as spline,Ze as stroke,Pe as strokeStyle,$ as translate,p as wRand};
//# sourceMappingURL=brush.esm.js.map
