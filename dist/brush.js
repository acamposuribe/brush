var t,e;t=this,e=function(t){const e=Math.sqrt(3),i=.5*(e-1),n=(3-e)/6,r=t=>0|Math.floor(t),o=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function s(t=Math.random){const e=function(t){const e=new Uint8Array(512);for(let t=0;t<256;t++)e[t]=t;for(let i=0;i<255;i++){const n=i+~~(t()*(256-i)),r=e[i];e[i]=e[n],e[n]=r}for(let t=256;t<512;t++)e[t]=e[t-256];return e}(t),s=new Float64Array(e).map((t=>o[t%12*2])),a=new Float64Array(e).map((t=>o[t%12*2+1]));return function(t,o){let c=0,l=0,h=0;const u=(t+o)*i,f=r(t+u),m=r(o+u),g=(f+m)*n,x=t-(f-g),d=o-(m-g);let p,y;x>d?(p=1,y=0):(p=0,y=1);const _=x-p+n,v=d-y+n,b=x-1+2*n,R=d-1+2*n,E=255&f,w=255&m;let S=.5-x*x-d*d;if(S>=0){const t=E+e[w];S*=S,c=S*S*(s[t]*x+a[t]*d)}let A=.5-_*_-v*v;if(A>=0){const t=E+p+e[w+y];A*=A,l=A*A*(s[t]*_+a[t]*v)}let P=.5-b*b-R*R;if(P>=0){const t=E+1+e[w+1];P*=P,h=P*P*(s[t]*b+a[t]*R)}return 70*(c+l+h)}}function a(t,e){let i=new c(t),n=()=>i.next();return n.double=()=>n()+11102230246251565e-32*(2097152*n()|0),n.int32=()=>4294967296*i.next()|0,n.quick=n,n}class c{constructor(t){null==t&&(t=+new Date);let e=4022871197;function i(t){t=String(t);for(let i=0;i<t.length;i++){e+=t.charCodeAt(i);let n=.02519603282416938*e;e=n>>>0,n-=e,n*=e,e=n>>>0,n-=e,e+=4294967296*n}return 2.3283064365386963e-10*(e>>>0)}this.c=1,this.s0=i(" "),this.s1=i(" "),this.s2=i(" "),this.s0-=i(t),this.s0<0&&(this.s0+=1),this.s1-=i(t),this.s1<0&&(this.s1+=1),this.s2-=i(t),this.s2<0&&(this.s2+=1)}next(){let{c:t,s0:e,s1:i,s2:n}=this,r=2091639*e+2.3283064365386963e-10*t;return this.s0=i,this.s1=n,this.s2=r-(this.c=0|r)}copy(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}}let l=a(Math.random());t.noise=s(a(Math.random()));const h=(t=0,e=1)=>t+l()*(e-t);function u(t){return t[~~(l()*t.length)]}const f=(t,e)=>~~h(t,e);function m(t=0,e=1){const i=1-l(),n=l();return Math.sqrt(-2*Math.log(i))*R(360*n)*e+t}function g(t){let e=0;const i=[];for(const n in t)e+=t[n],i.push({key:n,cumulative:e});const n=l()*e;for(const t of i)if(n<t.cumulative)return isNaN(t.key)?t.key:parseInt(t.key)}function x(t,e,i,n,r,o=!1){let s=n+(t-e)/(i-e)*(r-n);return o?n<r?d(s,n,r):d(s,r,n):s}function d(t,e,i){return Math.max(Math.min(t,i),e)}function p(t){return(t%=360)<0?t+360:t}const y=1440,_=2*Math.PI/y,v=new Float32Array(y).fill(NaN),b=new Float32Array(y).fill(NaN);function R(t){const e=~~(4*p(t));let i=v[e];return isNaN(i)&&(i=Math.cos(e*_),v[e]=i),i}function E(t){const e=~~(4*p(t));let i=b[e];return isNaN(i)&&(i=Math.sin(e*_),b[e]=i),i}const w=t=>{let e=180*t/Math.PI%360;return e<0?e+360:e};function S(t,e,i,n,r){let o=R(r),s=E(r);return{x:o*(i-t)+s*(n-e)+t,y:o*(n-e)-s*(i-t)+e}}const A=(t,e,i,n)=>Math.sqrt((i-t)*(i-t)+(n-e)*(n-e)),P=(t,e,i,n)=>w(Math.atan2(-(n-e),i-t));function T(t,e,i,n,r=!1){let o=t.x,s=t.y,a=e.x,c=e.y,l=i.x,h=i.y,u=n.x,f=n.y;if(o===a&&s===c||l===u&&h===f)return!1;let m=a-o,g=c-s,x=u-l,d=f-h,p=d*m-x*g;if(0===p)return!1;let y=(x*(s-h)-d*(o-l))/p,_=(m*(s-h)-g*(o-l))/p;return!(!r&&(_<0||_>1))&&{x:o+y*m,y:s+y*g}}function I(t){return t.map((function(t){return t.slice()}))}const C=()=>{let t,e;const i={};function n(){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8,t.width,t.height),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),i}function r(){let t=n();const i=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),{texture:t,fbo:i}}function o(){return self.navigator&&/Safari/.test(self.navigator.userAgent)&&!/Chrome/.test(self.navigator.userAgent)}function s(){e.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,e.COLOR_BUFFER_BIT,e.NEAREST)}onmessage=async a=>{a.data.canvas?(t=a.data.canvas,function(){e=t.getContext("webgl2",{antialias:!1});const o=(t=>{const e=t.createProgram();for(let[i,n]of[[t.VERTEX_SHADER,"#version 300 es\n#define GLSLIFY 1\nout vec2 p;void main(){vec3 v=vec3(-1);v[gl_VertexID]=3.;gl_Position=vec4(p=v.xy,0,1);}"],[t.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nuniform vec4 u_addColor;uniform bool u_isErase;uniform bool u_isImage;uniform bool u_isBrush;uniform sampler2D u_source;uniform sampler2D u_mask;in vec2 p;out vec4 outColor;const int SPECTRAL_SIZE=38;const float SPECTRAL_GAMMA=2.4;const float SPECTRAL_EPSILON=0.0000000000000001;float spectral_uncompand(float x){return(x<0.04045)? x/12.92 : pow((x+0.055)/1.055,SPECTRAL_GAMMA);}float spectral_compand(float x){return(x<0.0031308)? x*12.92 : 1.055*pow(x,1.0/SPECTRAL_GAMMA)-0.055;}vec3 spectral_srgb_to_linear(vec3 srgb){return vec3(spectral_uncompand(srgb[0]),spectral_uncompand(srgb[1]),spectral_uncompand(srgb[2]));}vec3 spectral_linear_to_srgb(vec3 lrgb){return clamp(vec3(spectral_compand(lrgb[0]),spectral_compand(lrgb[1]),spectral_compand(lrgb[2])),0.,1.);}void spectral_linear_to_reflectance(vec3 lrgb,inout float R[SPECTRAL_SIZE]){float w=min(lrgb.r,min(lrgb.g,lrgb.b));lrgb-=w;float c=min(lrgb.g,lrgb.b);float m=min(lrgb.r,lrgb.b);float y=min(lrgb.r,lrgb.g);float r=min(max(0.0,lrgb.r-lrgb.b),max(0.0,lrgb.r-lrgb.g));float g=min(max(0.0,lrgb.g-lrgb.b),max(0.0,lrgb.g-lrgb.r));float b=min(max(0.0,lrgb.b-lrgb.g),max(0.0,lrgb.b-lrgb.r));R[0]=max(SPECTRAL_EPSILON,w*1.0011607271876400+c*0.9705850013229620+m*0.9906735573199880+y*0.0210523371789306+r*0.0315605737777207+g*0.0095560747554212+b*0.9794047525020140);R[1]=max(SPECTRAL_EPSILON,w*1.0011606515972800+c*0.9705924981434250+m*0.9906715249619790+y*0.0210564627517414+r*0.0315520718330149+g*0.0095581580120851+b*0.9794007068431300);R[2]=max(SPECTRAL_EPSILON,w*1.0011603192274700+c*0.9706253487298910+m*0.9906625823534210+y*0.0210746178695038+r*0.0315148215513658+g*0.0095673245444588+b*0.9793829034702610);R[3]=max(SPECTRAL_EPSILON,w*1.0011586727078900+c*0.9707868061190170+m*0.9906181076447950+y*0.0211649058448753+r*0.0313318044982702+g*0.0096129126297349+b*0.9792943649455940);R[4]=max(SPECTRAL_EPSILON,w*1.0011525984455200+c*0.9713686732282480+m*0.9904514808787100+y*0.0215027957272504+r*0.0306729857725527+g*0.0097837090401843+b*0.9789630146085700);R[5]=max(SPECTRAL_EPSILON,w*1.0011325252899800+c*0.9731632306212520+m*0.9898710814002040+y*0.0226738799041561+r*0.0286480476989607+g*0.0103786227058710+b*0.9778144666940430);R[6]=max(SPECTRAL_EPSILON,w*1.0010850066332700+c*0.9767402231587650+m*0.9882866087596400+y*0.0258235649693629+r*0.0246450407045709+g*0.0120026452378567+b*0.9747243211338360);R[7]=max(SPECTRAL_EPSILON,w*1.0009968788945300+c*0.9815876054913770+m*0.9842906927975040+y*0.0334879385639851+r*0.0192960753663651+g*0.0160977721473922+b*0.9671984823439730);R[8]=max(SPECTRAL_EPSILON,w*1.0008652515227400+c*0.9862802656529490+m*0.9739349056253060+y*0.0519069663740307+r*0.0142066612220556+g*0.0267061902231680+b*0.9490796575305750);R[9]=max(SPECTRAL_EPSILON,w*1.0006962900094000+c*0.9899491476891340+m*0.9418178384601450+y*0.1007490148334730+r*0.0102942608878609+g*0.0595555440185881+b*0.9008501289409770);R[10]=max(SPECTRAL_EPSILON,w*1.0005049611488800+c*0.9924927015384200+m*0.8173903261951560+y*0.2391298997068470+r*0.0076191460521811+g*0.1860398265328260+b*0.7631504454622400);R[11]=max(SPECTRAL_EPSILON,w*1.0003080818799200+c*0.9941456804052560+m*0.4324728050657290+y*0.5348043122727480+r*0.0058980410835420+g*0.5705798201161590+b*0.4659221716493190);R[12]=max(SPECTRAL_EPSILON,w*1.0001196660201300+c*0.9951839750332120+m*0.1384539782588700+y*0.7978075786430300+r*0.0048233247781713+g*0.8614677684002920+b*0.2012632804510050);R[13]=max(SPECTRAL_EPSILON,w*0.9999527659684070+c*0.9957567501108180+m*0.0537347216940033+y*0.9114498940673840+r*0.0042298748350633+g*0.9458790897676580+b*0.0877524413419623);R[14]=max(SPECTRAL_EPSILON,w*0.9998218368992970+c*0.9959128182867100+m*0.0292174996673231+y*0.9537979630045070+r*0.0040599171299341+g*0.9704654864743050+b*0.0457176793291679);R[15]=max(SPECTRAL_EPSILON,w*0.9997386095575930+c*0.9956061578345280+m*0.0213136517508590+y*0.9712416154654290+r*0.0043533695594676+g*0.9784136302844500+b*0.0284706050521843);R[16]=max(SPECTRAL_EPSILON,w*0.9997095516396120+c*0.9945976009618540+m*0.0201349530181136+y*0.9793031238075880+r*0.0053434425970201+g*0.9795890314112240+b*0.0205271767569850);R[17]=max(SPECTRAL_EPSILON,w*0.9997319302106270+c*0.9922157154923700+m*0.0241323096280662+y*0.9833801195075750+r*0.0076917201010463+g*0.9755335369086320+b*0.0165302792310211);R[18]=max(SPECTRAL_EPSILON,w*0.9997994363461950+c*0.9862364527832490+m*0.0372236145223627+y*0.9854612465677550+r*0.0135969795736536+g*0.9622887553978130+b*0.0145135107212858);R[19]=max(SPECTRAL_EPSILON,w*0.9999003303166710+c*0.9679433372645410+m*0.0760506552706601+y*0.9864350469766050+r*0.0316975442661115+g*0.9231215745131200+b*0.0136003508637687);R[20]=max(SPECTRAL_EPSILON,w*1.0000204065261100+c*0.8912850042449430+m*0.2053754719423990+y*0.9867382506701410+r*0.1078611963552490+g*0.7934340189431110+b*0.0133604258769571);R[21]=max(SPECTRAL_EPSILON,w*1.0001447879365800+c*0.5362024778620530+m*0.5412689034604390+y*0.9866178824450320+r*0.4638126031687040+g*0.4592701359024290+b*0.0135488943145680);R[22]=max(SPECTRAL_EPSILON,w*1.0002599790341200+c*0.1541081190018780+m*0.8158416850864860+y*0.9862777767586430+r*0.8470554052720110+g*0.1855741036663030+b*0.0139594356366992);R[23]=max(SPECTRAL_EPSILON,w*1.0003557969708900+c*0.0574575093228929+m*0.9128177041239760+y*0.9858605924440560+r*0.9431854093939180+g*0.0881774959955372+b*0.0144434255753570);R[24]=max(SPECTRAL_EPSILON,w*1.0004275378026900+c*0.0315349873107007+m*0.9463398301669620+y*0.9854749276762100+r*0.9688621506965580+g*0.0543630228766700+b*0.0148854440621406);R[25]=max(SPECTRAL_EPSILON,w*1.0004762334488800+c*0.0222633920086335+m*0.9599276963319910+y*0.9851769347655580+r*0.9780306674736030+g*0.0406288447060719+b*0.0152254296999746);R[26]=max(SPECTRAL_EPSILON,w*1.0005072096750800+c*0.0182022841492439+m*0.9662605952303120+y*0.9849715740141810+r*0.9820436438543060+g*0.0342215204316970+b*0.0154592848180209);R[27]=max(SPECTRAL_EPSILON,w*1.0005251915637300+c*0.0162990559732640+m*0.9693259700584240+y*0.9848463034157120+r*0.9839236237187070+g*0.0311185790956966+b*0.0156018026485961);R[28]=max(SPECTRAL_EPSILON,w*1.0005350960689600+c*0.0153656239334613+m*0.9708545367213990+y*0.9847753518111990+r*0.9848454841543820+g*0.0295708898336134+b*0.0156824871281936);R[29]=max(SPECTRAL_EPSILON,w*1.0005402209748200+c*0.0149111568733976+m*0.9716050665281280+y*0.9847380666252650+r*0.9852942758145960+g*0.0288108739348928+b*0.0157248764360615);R[30]=max(SPECTRAL_EPSILON,w*1.0005427281678400+c*0.0146954339898235+m*0.9719627697573920+y*0.9847196483117650+r*0.9855072952198250+g*0.0284486271324597+b*0.0157458108784121);R[31]=max(SPECTRAL_EPSILON,w*1.0005438956908700+c*0.0145964146717719+m*0.9721272722745090+y*0.9847110233919390+r*0.9856050715398370+g*0.0282820301724731+b*0.0157556123350225);R[32]=max(SPECTRAL_EPSILON,w*1.0005444821215100+c*0.0145470156699655+m*0.9722094177458120+y*0.9847066833006760+r*0.9856538499335780+g*0.0281988376490237+b*0.0157605443964911);R[33]=max(SPECTRAL_EPSILON,w*1.0005447695999200+c*0.0145228771899495+m*0.9722495776784240+y*0.9847045543930910+r*0.9856776850338830+g*0.0281581655342037+b*0.0157629637515278);R[34]=max(SPECTRAL_EPSILON,w*1.0005448988776200+c*0.0145120341118965+m*0.9722676219987420+y*0.9847035963093700+r*0.9856883918061220+g*0.0281398910216386+b*0.0157640525629106);R[35]=max(SPECTRAL_EPSILON,w*1.0005449625468900+c*0.0145066940939832+m*0.9722765094621500+y*0.9847031240775520+r*0.9856936646900310+g*0.0281308901665811+b*0.0157645892329510);R[36]=max(SPECTRAL_EPSILON,w*1.0005449892705800+c*0.0145044507314479+m*0.9722802433068740+y*0.9847029256150900+r*0.9856958798482050+g*0.0281271086805816+b*0.0157648147772649);R[37]=max(SPECTRAL_EPSILON,w*1.0005449969930000+c*0.0145038009464639+m*0.9722813248265600+y*0.9847028681227950+r*0.9856965214637620+g*0.0281260133612096+b*0.0157648801149616);}vec3 spectral_xyz_to_srgb(vec3 xyz){mat3 XYZ_RGB;XYZ_RGB[0]=vec3(3.2409699419045200,-1.537383177570090,-0.4986107602930030);XYZ_RGB[1]=vec3(-0.9692436362808790,1.875967501507720,0.0415550574071756);XYZ_RGB[2]=vec3(0.0556300796969936,-0.203976958888976,1.0569715142428700);float r=dot(XYZ_RGB[0],xyz);float g=dot(XYZ_RGB[1],xyz);float b=dot(XYZ_RGB[2],xyz);return spectral_linear_to_srgb(vec3(r,g,b));}vec3 spectral_reflectance_to_xyz(float R[SPECTRAL_SIZE]){vec3 xyz=vec3(0.);xyz+=R[0]*vec3(0.0000646919989576,0.0000018442894440,0.0003050171476380);xyz+=R[1]*vec3(0.0002194098998132,0.0000062053235865,0.0010368066663574);xyz+=R[2]*vec3(0.0011205743509343,0.0000310096046799,0.0053131363323992);xyz+=R[3]*vec3(0.0037666134117111,0.0001047483849269,0.0179543925899536);xyz+=R[4]*vec3(0.0118805536037990,0.0003536405299538,0.0570775815345485);xyz+=R[5]*vec3(0.0232864424191771,0.0009514714056444,0.1136516189362870);xyz+=R[6]*vec3(0.0345594181969747,0.0022822631748318,0.1733587261835500);xyz+=R[7]*vec3(0.0372237901162006,0.0042073290434730,0.1962065755586570);xyz+=R[8]*vec3(0.0324183761091486,0.0066887983719014,0.1860823707062960);xyz+=R[9]*vec3(0.0212332056093810,0.0098883960193565,0.1399504753832070);xyz+=R[10]*vec3(0.0104909907685421,0.0152494514496311,0.0891745294268649);xyz+=R[11]*vec3(0.0032958375797931,0.0214183109449723,0.0478962113517075);xyz+=R[12]*vec3(0.0005070351633801,0.0334229301575068,0.0281456253957952);xyz+=R[13]*vec3(0.0009486742057141,0.0513100134918512,0.0161376622950514);xyz+=R[14]*vec3(0.0062737180998318,0.0704020839399490,0.0077591019215214);xyz+=R[15]*vec3(0.0168646241897775,0.0878387072603517,0.0042961483736618);xyz+=R[16]*vec3(0.0286896490259810,0.0942490536184085,0.0020055092122156);xyz+=R[17]*vec3(0.0426748124691731,0.0979566702718931,0.0008614711098802);xyz+=R[18]*vec3(0.0562547481311377,0.0941521856862608,0.0003690387177652);xyz+=R[19]*vec3(0.0694703972677158,0.0867810237486753,0.0001914287288574);xyz+=R[20]*vec3(0.0830531516998291,0.0788565338632013,0.0001495555858975);xyz+=R[21]*vec3(0.0861260963002257,0.0635267026203555,0.0000923109285104);xyz+=R[22]*vec3(0.0904661376847769,0.0537414167568200,0.0000681349182337);xyz+=R[23]*vec3(0.0850038650591277,0.0426460643574120,0.0000288263655696);xyz+=R[24]*vec3(0.0709066691074488,0.0316173492792708,0.0000157671820553);xyz+=R[25]*vec3(0.0506288916373645,0.0208852059213910,0.0000039406041027);xyz+=R[26]*vec3(0.0354739618852640,0.0138601101360152,0.0000015840125870);xyz+=R[27]*vec3(0.0214682102597065,0.0081026402038399,0.0000000000000000);xyz+=R[28]*vec3(0.0125164567619117,0.0046301022588030,0.0000000000000000);xyz+=R[29]*vec3(0.0068045816390165,0.0024913800051319,0.0000000000000000);xyz+=R[30]*vec3(0.0034645657946526,0.0012593033677378,0.0000000000000000);xyz+=R[31]*vec3(0.0014976097506959,0.0005416465221680,0.0000000000000000);xyz+=R[32]*vec3(0.0007697004809280,0.0002779528920067,0.0000000000000000);xyz+=R[33]*vec3(0.0004073680581315,0.0001471080673854,0.0000000000000000);xyz+=R[34]*vec3(0.0001690104031614,0.0000610327472927,0.0000000000000000);xyz+=R[35]*vec3(0.0000952245150365,0.0000343873229523,0.0000000000000000);xyz+=R[36]*vec3(0.0000490309872958,0.0000177059860053,0.0000000000000000);xyz+=R[37]*vec3(0.0000199961492222,0.0000072209749130,0.0000000000000000);return xyz;}float KS(float R){return pow(1.0-R,2.0)/(2.0*R);}float KM(float KS){return 1.0+KS-sqrt(pow(KS,2.0)+2.0*KS);}vec3 spectral_mix(vec3 color1,float tintingStrength1,float factor1,vec3 color2,float tintingStrength2,float factor2){vec3 lrgb1=spectral_srgb_to_linear(color1);vec3 lrgb2=spectral_srgb_to_linear(color2);float R1[SPECTRAL_SIZE];float R2[SPECTRAL_SIZE];spectral_linear_to_reflectance(lrgb1,R1);spectral_linear_to_reflectance(lrgb2,R2);float luminance1=spectral_reflectance_to_xyz(R1)[1];float luminance2=spectral_reflectance_to_xyz(R2)[1];float R[SPECTRAL_SIZE];for(int i=0;i<SPECTRAL_SIZE;i++){float concentration1=pow(factor1,2.)*pow(tintingStrength1,2.)*luminance1;float concentration2=pow(factor2,2.)*pow(tintingStrength2,2.)*luminance2;float totalConcentration=concentration1+concentration2;float ksMix=0.;ksMix+=KS(R1[i])*concentration1;ksMix+=KS(R2[i])*concentration2;R[i]=KM(ksMix/totalConcentration);}return spectral_xyz_to_srgb(spectral_reflectance_to_xyz(R));}vec3 spectral_mix(vec3 color1,vec3 color2,float factor){return spectral_mix(color1,1.,1.-factor,color2,1.,factor);}void main(void){vec2 uv=.5*vec2(p.x,p.y)+.5;vec4 source=texture(u_source,uv);if(u_isImage){vec4 maskColor=texture(u_mask,uv);outColor=maskColor;}else{vec4 maskColor=texture(u_mask,uv);if(maskColor.r>0.){vec4 pigment=vec4(u_addColor.xyz,1.0);float darken_above=0.7;if(maskColor.a>darken_above&&!u_isErase){float blacken=0.5*(maskColor.a-darken_above);pigment=pigment*(1.-blacken)-vec4(0.5)*blacken;}float mixIntensity=maskColor.a;if(!u_isBrush){vec2 texelSize=1.0/vec2(textureSize(u_mask,0));float scaleFactor=15.0;float scaledAlpha=maskColor.a*scaleFactor;float edge=length(vec2(dFdx(scaledAlpha),dFdy(scaledAlpha)));float edgeCenter=smoothstep(0.05,0.35,edge);float blurEdge=0.0;float totalSamples=0.0;for(int i=-2;i<=2;i++){for(int j=-2;j<=2;j++){vec2 offset=vec2(float(i),float(j))*texelSize;vec2 sampleUV=uv+offset;float neighborAlpha=texture(u_mask,sampleUV).a*scaleFactor;float neighborEdge=length(vec2(dFdx(neighborAlpha),dFdy(neighborAlpha)));blurEdge+=smoothstep(0.05,0.35,neighborEdge);totalSamples+=1.0;}}blurEdge/=totalSamples;mixIntensity=clamp(maskColor.a+blurEdge*0.2,0.0,1.0);}vec3 mixedColor=spectral_mix(source.rgb,pigment.rgb,mixIntensity);outColor=vec4(mixedColor,1);}else{outColor=source;}}}"]]){const r=t.createShader(i);t.shaderSource(r,n),t.compileShader(r),t.attachShader(e,r)}return t.linkProgram(e),e})(e);e.useProgram(o),["u_addColor","u_isErase","u_isImage","u_isBrush","u_source","u_mask"].forEach((t=>{i[t]=e.getUniformLocation(o,t)})),i.mask=n(),i.source=r(),i.target=r(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.source.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i.mask),e.uniform1i(i.u_source,0),e.uniform1i(i.u_mask,1)}(),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),e.clearColor(1,1,1,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)):a.data.isBG?(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),e.clearColor(...a.data.color),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)):a.data.mask&&function(t){let n;if(o()){const e=new OffscreenCanvas(t.mask.width,t.mask.height).getContext("2d");e.drawImage(t.mask,0,0),n=e.getImageData(0,0,t.mask.width,t.mask.height)}e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,o()?n:t.mask),t.mask.close(),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.target.fbo),e.uniform1i(i.u_isImage,t.isImage?1:0),e.uniform1i(i.u_isBrush,t.isBrush?1:0),t.isImage||(e.uniform1i(i.u_isImage,!1),e.uniform4f(i.u_addColor,...t.addColor),e.uniform1i(i.u_isErase,!!t.isErase)),e.drawArrays(e.TRIANGLES,0,3),e.bindFramebuffer(e.READ_FRAMEBUFFER,i.target.fbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.source.fbo),s(),t.isLast&&!t.sp&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,i.target.fbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),s())}(a.data)}};Worker.createURL=function(t){const e="function"==typeof t?t.toString():t,i=new Blob(["'use strict';\nself.onmessage="+e],{type:"text/javascript"});return window.URL.createObjectURL(i)},Worker.create=function(t){return new Worker(Worker.createURL(t))};const k={};let L,M,F,z=!1;const B={},N=document.createElement("canvas");N.width=1,N.height=1;const O=N.getContext("2d");class X{constructor(t,e,i){if(isNaN(t)){this.hex=this.standardize(t);let e=this.hexToRgb(this.hex);this.r=e.r,this.g=e.g,this.b=e.b}else t=d(t,0,255),e=d(e,0,255),i=d(i,0,255),this.r=t,this.g=isNaN(e)?t:e,this.b=isNaN(i)?t:i,this.hex=this.rgbToHex(this.r,this.g,this.b);this.gl=[this.r/255,this.g/255,this.b/255,1]}rgbToHex(t,e,i){return"#"+(1<<24|t<<16|e<<8|i).toString(16).slice(1)}hexToRgb(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,i,n){return e+e+i+i+n+n}));let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}standardize(t){return O.fillStyle=t,O.fillStyle}}function Y(){U.loaded||(function(){if(!z)throw new Error("Canvas system is not ready. Call `load()` first.")}(),U.load())}const U={loaded:!1,isBlending:!1,currentColor:new X("white").gl,load(){if(!k[L].worker){const t=k[L];t.mask=new OffscreenCanvas(M,F),t.glMask=new OffscreenCanvas(M,F),t.ctx=t.mask.getContext("2d"),t.gl=t.glMask.getContext("webgl2"),t.ctx.lineWidth=0,t.offscreen=k[L].canvas.transferControlToOffscreen(),t.worker=Worker.create(C),t.worker.postMessage("init"),t.worker.postMessage({canvas:t.offscreen},[t.offscreen])}Object.assign(this,k[L])},blend(t=!1,e=!1,i=!1,n=!1){Y(),!this.isBlending&&t&&(this.currentColor=t.gl,this.isBlending=!0);const r=t?t.gl:this.currentColor;if(e||i||r.toString()!==this.currentColor.toString()){const r=i||this.isBrush?this.glMask.transferToImageBitmap():this.mask.transferToImageBitmap();this.worker.postMessage({addColor:this.currentColor,mask:r,isLast:e,isErase:this.isErase,isImage:Boolean(i),sp:n,isBrush:this.isBrush},[r]),this.isErase=!1,this.isBrush=!1,e||(this.currentColor=t.gl),e&&!n&&(this.isBlending=!1)}}};let D=new X("white");const W={x:0,y:0};let G=!1;function q(){G||(Y(),Z=.01*M,j=-.5*M,V=-.5*F,K=Math.round(2*M/Z),$=Math.round(2*F/Z),tt("hand",(function(e,i){const n=h(.2,.8),r=f(5,10),o=.1*e;for(let s=0;s<K;s++){const a=.1*s+o;for(let c=0;c<$;c++){const l=r*E(n*c*s+f(15,25)),h=t.noise(a,.1*c+o);i[s][c]=.5*l*R(e)+h*r*.5}}return i})),tt("seabed",(function(t,e){const i=h(.4,.8),n=f(18,26);for(let r=0;r<K;r++)for(let o=0;o<$;o++){const s=n*E(i*o*r+f(15,20));e[r][o]=1.1*s*R(t)}return e})),et.genField(),G=!0)}class H{constructor(t,e){this.update(t,e),this.plotted=0}update(t,e){this.x=t,this.y=e,this.column_index=H.getColIndex(t),this.row_index=H.getRowIndex(e)}reset(){this.plotted=0}isIn(){return B.field.isActive?H.isIn(this.column_index,this.row_index):this.isInCanvas(this.x,this.y)}isInCanvas(){const t=M,e=F,i=this.x+W.x,n=this.y+W.y;return i>=-.3*t&&i<=1.3*t&&n>=-.3*e&&n<=1.3*e}angle(){return this.isIn()&&B.field.isActive?J.get(B.field.current).field[this.column_index][this.row_index]:0}moveTo(t,e,i,n=!0){if(!this.isIn())return void(this.plotted+=i);let r,o;for(let s=0;s<t/i;s++){if(n){const t=this.angle();r=R(t-e),o=E(t-e)}else r=R(-e),o=E(-e);const t=i*r,s=i*o;this.plotted+=i,this.update(this.x+t,this.y+s)}}plotTo(t,e,i,n){if(!this.isIn())return void(this.plotted+=i/n);const r=1/n;for(let n=0;n<e/i;n++){const e=this.angle(),n=t.angle(this.plotted),o=i*R(e-n),s=i*E(e-n);this.plotted+=i*r,this.update(this.x+o,this.y+s)}}static getRowIndex(t,e=1){const i=t+W.y-V;return Math.round(i/Z/e)}static getColIndex(t,e=1){const i=t+W.x-j;return Math.round(i/Z/e)}static isIn(t,e){return t>=0&&e>=0&&t<K&&e<$}}B.field={isActive:!1,current:null};let Z,j,V,K,$,J=new Map;function Q(t=1){return new Array(K/t).fill(null).map((()=>new Float32Array($/t)))}function tt(t,e){J.set(t,{gen:e}),J.get(t).field=J.get(t).gen(0,Q())}const et={d:4,genField(){this.field=Q(this.d),this.fieldTemp=Q(this.d)},get(t,e,i=!1){const n=H.getColIndex(t,this.d),r=H.getRowIndex(e,this.d),o=this.field?.[n]?.[r]??0;if(i){const t=Math.max(o,i),e=.75*(0===o?0:this.fieldTemp[n][r]);return this.fieldTemp[n][r]=Math.max(t,e),t}return o},update(){for(let t=0;t<K/this.d;t++)for(let e=0;e<$/this.d;e++)this.field[t][e]=this.fieldTemp[t][e]},save(){this.A=I(this.field),this.B=I(this.fieldTemp)},restore(){this.field=this.A,this.fieldTemp=this.B}};let it={};function nt(t){U.ctx.beginPath(),t.forEach(((t,e)=>{0===e?U.ctx.moveTo(t.x,t.y):U.ctx.lineTo(t.x,t.y)})),U.ctx.closePath()}function rt(t,e,i){const n=2*Math.PI,r=i/2;U.ctx.moveTo(t+r,e),U.ctx.arc(t,e,r,0,n)}const ot={isActive:!1,c:null,a:255};function st(t){Mix.blend(ot.c),Mix.isErase=!0,Mix.ctx.save(),Mix.ctx.fillStyle="rgb(255 0 0 / "+ot.a+"%)",nt(t),Mix.ctx.fill(),Mix.ctx.restore()}class at{constructor(t,e=!1){this.a=t,this.vertices=e?t:t.map((([t,e])=>({x:t,y:e}))),this.sides=this.vertices.map(((t,e,i)=>[t,i[(e+1)%i.length]])),this._intersectionCache={}}intersect(t){const e=`${t.point1.x},${t.point1.y}-${t.point2.x},${t.point2.y}`;if(this._intersectionCache[e])return this._intersectionCache[e];const i=[];for(const[e,n]of this.sides){const r=T(t.point1,t.point2,e,n);r&&i.push(r)}return this._intersectionCache[e]=i,i}erase(){ot.isActive&&st(this.vertices)}show(){B.draw&&this.draw(),B.hatch&&this.hatch(),B.fill&&this.fill(),this.erase()}}class ct{constructor(t){this.segments=[],this.angles=[],this.pres=[],this.type=t,this.dir=0,this.calcIndex(0),this.pol=!1}addSegment(t=0,e=0,i=1,n=!1){this.angles.length>0&&this.angles.pop(),t=n?(t%360+360)%360:w(t),this.angles.push(t,t),this.pres.push(i),this.segments.push(e),this.length=this.segments.reduce(((t,e)=>t+e),0)}endPlot(t=0,e=1,i=!1){t=i?(t%360+360)%360:w(t),this.angles[this.angles.length-1]=t,this.pres.push(e)}rotate(t){this.dir=w(t)}pressure(t){return t>this.length?this.pres[this.pres.length-1]:this.curving(this.pres,t)}angle(t){return t>this.length?this.angles[this.angles.length-1]:(this.calcIndex(t),"curve"===this.type?this.curving(this.angles,t)+this.dir:this.angles[this.index]+this.dir)}curving(t,e){let i=t[this.index],n=t[this.index+1]??i;return Math.abs(n-i)>180&&(n>i?n=-(360-n):i=-(360-i)),x(e-this.suma,0,this.segments[this.index],i,n,!0)}calcIndex(t){this.index=-1,this.suma=0;let e=0;for(;e<=t;)this.suma=e,e+=this.segments[this.index+1],this.index++;return this.index}genPol(t,e,i=1,n){q();const r=.5,o=[],s=Math.round(this.length/r),a=new H(t,e);let c=0,l=0;for(let t=0;t<s;t++){a.plotTo(this,r,r,1);const t=this.calcIndex(a.plotted);c+=r,(c>=Math.max(this.segments[t]*n*h(.7,1.3),10)||t>=l)&&a.x&&(o.push([a.x,a.y]),c=0,t>=l&&l++)}return new at(o)}erase(t,e,i){ot.isActive&&(this.origin&&([t,e,i]=[...this.origin,1]),this.pol=this.genPol(t,e,i,.15),st(this.pol.vertices))}show(t,e,i=1){B.stroke&&this.draw(t,e,i),B.hatch&&this.hatch(t,e,i),B.fill&&this.fill(t,e,i),this.erase(t,e,i)}}let lt,ht,ut,ft,mt;class gt{constructor(){this.isClosed=!1,this.curvature=ut,this.vert=[]}vertex(t,e,i){this.vert.push([t,e,i])}show(){vt(this.vert,this.curvature,this.isClosed).show()}}function xt(t=0){ut=d(t,0,1),lt=[]}function dt(t,e,i=1){ht=new gt,lt.push(ht),ht.vertex(t,e,i)}function pt(t,e,i=1){ht.vertex(t,e,i)}function yt(){ht.vertex(...ht.vert[0]),ht.isClosed=!0}function _t(){for(let t of lt)t.show();lt=!1}function vt(t,e=.5,i=!1){const n=new ct(0===e?"segments":"curve"),r=2*Math.PI;if(i&&0!==e&&t.push(t[1]),t&&t.length>0){let o,s,a,c=0;for(let l=0;l<t.length-1;l++)if(e>0&&l<t.length-2){const h=t[l],u=t[l+1],f=t[l+2],m=A(h[0],h[1],u[0],u[1]),g=A(u[0],u[1],f[0],f[1]),x=P(h[0],h[1],u[0],u[1]),d=P(u[0],u[1],f[0],f[1]),p=e*Math.min(m,g,.5*Math.min(m,g)),y=Math.max(m,g),_=m-p,v=g-p;if(Math.floor(x)===Math.floor(d)){const e=i&&0===l?0:m-c,r=i?0===l?0:g-a:g;n.addSegment(x,e,h[2],!0),l===t.length-3&&n.addSegment(d,r,u[2],!0),c=0,0===l&&(o=m,a=p,s=t[1],c=0)}else{const e={x:u[0]-p*R(-x),y:u[1]-p*E(-x)},f={x:e.x+y*R(90-x),y:e.y+y*E(90-x)},m={x:u[0]+p*R(-d),y:u[1]+p*E(-d)},g=T(e,f,m,{x:m.x+y*R(90-d),y:m.y+y*E(90-d)},!0),b=A(e.x,e.y,g.x,g.y),w=A(e.x,e.y,m.x,m.y)/2,S=r*b*(2*Math.asin(w/b)*(180/Math.PI))/360,P=i&&0===l?0:_-c,I=l===t.length-3?i?o-p:v:0;n.addSegment(x,P,h[2],!0),n.addSegment(x,isNaN(S)?0:S,h[2],!0),n.addSegment(d,I,u[2],!0),c=p,0===l&&(o=_,a=p,s=[e.x,e.y])}l===t.length-3&&n.endPlot(d,u[2],!0)}else if(0===e){const e=t[l],i=t[l+1],r=A(e[0],e[1],i[0],i[1]),o=P(e[0],e[1],i[0],i[1]);n.addSegment(o,r,i[2],!0),l===t.length-2&&n.endPlot(o,1,!0)}n.origin=i&&0!==e?s:t[0]}return n}let bt,Rt=0,Et=!0,wt=30;t.frameCount=0;let St=t=>(t&&(wt=t),wt);function At(e){Et&&(e>Rt+1e3/St()||0===e)&&(Rt=e,t.frameCount++,bt&&bt(),Pt()),requestAnimationFrame(At)}function Pt(){U.blend(!1,!0)}let Tt,It,Ct=!1;function kt(){Ct||(Y(),Tt=U.gl,It=new Float32Array([2/M,0,0,0,0,-2/F,0,0,0,0,1,0,-1,1,0,1]),function(){const t=((t,e,i)=>{const n=t.createProgram();for(let[r,o]of[[t.VERTEX_SHADER,e],[t.FRAGMENT_SHADER,i]]){const e=t.createShader(r);t.shaderSource(e,o),t.compileShader(e),t.attachShader(n,e)}return t.linkProgram(n),n})(Tt,Lt,Mt);Tt.useProgram(t),Tt.enable(Tt.BLEND),Tt.blendFunc(Tt.ONE_MINUS_DST_ALPHA,Tt.ONE),["a_position","a_radius","a_alpha"].forEach((e=>Ft[e]=Tt.getAttribLocation(t,e))),["u_matrix","u_drawSquare"].forEach((e=>zt[e]=Tt.getUniformLocation(t,e)))}(),Ct=!0)}const Lt="#version 300 es\nin vec2 a_position;in float a_radius,a_alpha;uniform mat4 u_matrix;out float v_alpha;void main(){gl_Position=u_matrix*vec4(a_position,0,1);v_alpha=a_alpha;gl_PointSize=a_radius*2.;}",Mt="#version 300 es\nprecision highp float;uniform bool u_drawSquare;in float v_alpha;out vec4 outColor;void main(){if(u_drawSquare)outColor=vec4(vec3(1,0,0)*v_alpha,v_alpha);else{vec2 v=gl_PointCoord-vec2(.5);float e=length(v);if(e>.5)discard;outColor=vec4(vec3(1,0,0)*v_alpha,v_alpha*(1.-smoothstep(.45,.5,e)));}}",Ft={},zt={};function Bt(){const t=4*Float32Array.BYTES_PER_ELEMENT,e=new Float32Array(4*Nt.length);Nt.forEach(((t,i)=>{const n=4*i;e.set([t.x,t.y,t.radius,t.alpha],n)})),Nt=[];const{vao:i,buf:n}=function(t,e,i){const n=Tt.createVertexArray();Tt.bindVertexArray(n);const r=Tt.createBuffer();return Tt.bindBuffer(Tt.ARRAY_BUFFER,r),Tt.bufferData(Tt.ARRAY_BUFFER,t,Tt.STATIC_DRAW),e.forEach((t=>{const e=Ft[t.name];Tt.enableVertexAttribArray(e),Tt.vertexAttribPointer(e,t.size,Tt.FLOAT,!1,i,t.offset)})),{vao:n,buf:r}}(e,[{name:"a_position",size:2,offset:0},{name:"a_radius",size:1,offset:2*Float32Array.BYTES_PER_ELEMENT},{name:"a_alpha",size:1,offset:3*Float32Array.BYTES_PER_ELEMENT}],t);Tt.uniformMatrix4fv(zt.u_matrix,!1,It),Tt.uniform1i(zt.u_drawSquare,Ot?1:0),Tt.bindVertexArray(i),Tt.drawArrays(Tt.POINTS,0,e.length/4),Tt.bindVertexArray(null),Tt.deleteBuffer(n),Tt.deleteVertexArray(i)}let Nt=[],Ot=!1;function Xt(t,e,i,n){kt();const r=i/2/1.2;Nt.push({x:t+W.x,y:e+W.y,radius:r,alpha:n/100}),Ot=!0}const Yt=2*Math.PI;B.stroke={color:new X("black"),weight:1,clipWindow:null,type:"HB",isActive:!1};let Ut,Dt,Wt,Gt,qt,Ht=new Map;function Zt(){return{...B.stroke}}function jt(t){B.stroke={...t}}function Vt(t,e){e.type=["marker","custom","image","spray"].includes(e.type)?e.type:"default",Ht.set(t,{param:e,colors:[],buffers:[]})}function Kt(t){Ht.has(t)&&(B.stroke.type=t)}function $t(t,e,i){B.stroke.color=new X(...arguments),B.stroke.isActive=!0}function Jt(t){B.stroke.weight=t}function Qt(t,e,i=1){Kt(t),$t(e),Jt(i)}const te={};function ee(t,e,i,n,r){Ut=new H(t,e),Dt=i,Wt=n,Gt=r,Gt&&Gt.calcIndex(0)}const ie=[];function ne(t,e){e||(qt=t),function(){te.seed=99999*h();const{param:t}=Ht.get(B.stroke.type)??{};if(!t)return;te.p=t;const{pressure:e}=t;te.a="custom"!==e.type?h(-1,1):0,te.b="custom"!==e.type?h(1,1.5):0,te.cp="custom"!==e.type?h(3,3.5):h(-.2,.2),[te.min,te.max]=e.min_max,kt(),U.blend(B.stroke.color),U.isBrush=!0,te.alpha=ce(),ue()}();const i=function(){const{param:t}=Ht.get(B.stroke.type)??{};return t?"default"===t.type||"spray"===t.type?t.spacing/B.stroke.weight:t.spacing:1}(),n=Math.round(Dt*(e?t:1)/i);for(let r=0;r<n;r++)ie.length<2*n&&ie.push(m()),re(),e?Ut.plotTo(Gt,i,i,t,r<10):Ut.moveTo(i,t,i,Wt);Bt(B.stroke.color),ue()}function re(e=!1){if(!le())return;let i=e||oe();switch(i*=1-.2*t.noise(.01*Ut.plotted+te.seed,1)-.2*t.noise(.003*Ut.x,.003*Ut.y),te.p.type){case"spray":!function(t){const e=B.stroke.weight*te.p.vibration*t+B.stroke.weight*u(ie)*te.p.vibration/3,i=B.stroke.weight*h(.9,1.1),n=Math.ceil(te.p.quality/t);for(let t=0;t<n;t++){const t=h(.9,1.1),n=t*e*h(-1,1),r=h(-1,1),o=Math.sqrt((t*e)**2-n**2);Xt(Ut.x+n,Ut.y+r*o,i,te.alpha)}}(i);break;case"marker":he(i);break;case"custom":case"image":!function(t,e,i=!0){U.ctx.save();const n=i?B.stroke.weight*te.p.vibration:0,r=i?n*h(-1,1):0,o=i?n*h(-1,1):0;U.ctx.translate(Ut.x+r,Ut.y+o),function(t){U.ctx.scale(t,t);let e=0;"random"===te.p.rotate?e=f(0,Yt):"natural"===te.p.rotate&&(e=(Gt?-Gt.angle(Ut.plotted):-qt)+(Wt?Ut.angle():0),e=e*Math.PI/180),U.ctx.rotate(e)}(B.stroke.weight*t),te.p.tip(U.ctx),U.ctx.restore()}(i);break;default:!function(t){const e=B.stroke.weight*te.p.vibration*(te.p.definition+(1-te.p.definition)*u(ie)*ae(.5,.9,5,.2,1.2)/t);h(0,te.p.quality*t)>.4&&Xt(Ut.x+.7*e*h(-1,1),Ut.y+e*h(-1,1),t*te.p.weight*h(.85,1.15),te.alpha)}(i)}}function oe(){return Gt?se()*Gt.pressure(Ut.plotted):se()}function se(){return"custom"===te.p.pressure.type?x(te.p.pressure.curve(Ut.plotted/Dt)+te.cp,0,1,te.min,te.max,!0):ae()}function ae(t=.5+te.p.pressure.curve[0]*te.a,e=1-te.p.pressure.curve[1]*te.b,i=te.cp,n=te.min,r=te.max){return x(1/(1+Math.pow(Math.abs((Ut.plotted-t*Dt)/(e*Dt/2)),2*i)),0,1,n,r)}function ce(){return["default","spray"].includes(te.p.type)?te.p.opacity:te.p.opacity/B.stroke.weight}function le(){if(B.stroke.clipWindow)return Ut.x>=B.stroke.clipWindow[0]&&Ut.x<=B.stroke.clipWindow[2]&&Ut.y>=B.stroke.clipWindow[1]&&Ut.y<=B.stroke.clipWindow[3];{let t=M,e=F,i=.05*M,n=Ut.x+W.x,r=Ut.y+W.y;return n>=-i&&n<=t+i&&r>=-i&&r<=e+i}}function he(t,e=!0,i=te.alpha){const n=e?B.stroke.weight*te.p.vibration:0,r=e?n*h(-1,1):0,o=e?n*h(-1,1):0;!function(t,e,i,n){kt();const r=i/2;Nt.push({x:t+W.x,y:e+W.y,radius:r,alpha:n/100}),Ot=!1}(Ut.x+r,Ut.y+o,B.stroke.weight*te.p.weight*t,i)}function ue(){if(le()){let t=oe(),e=ce();if("marker"===te.p.type){for(let i=1;i<10;i++)he(t*i/10,!1,5*e);Bt(B.stroke.color)}else if("custom"===te.p.type||"image"===te.p.type)for(let i=1;i<5;i++)U.ctx.beginPath(),te.drawCustomOrImage(t*i/5,e,!1),U.ctx.fill()}}function fe(t,e,i,n){q();let r=A(t,e,i,n);0!=r&&(ee(t,e,r,!0,!1),ne(P(t,e,i,n),!1))}const me=["weight","vibration","definition","quality","opacity","spacing","pressure","type","tip","rotate"],ge=[["pen",[.35,.12,.5,8,88,.3,{curve:[.15,.2],min_max:[1.4,.9]}]],["rotring",[.2,.05,.5,30,115,.15,{curve:[.35,.2],min_max:[1.3,.9]}]],["2B",[.35,.6,.1,8,140,.2,{curve:[.15,.2],min_max:[1.5,1]}]],["HB",[.3,.5,.4,4,130,.25,{curve:[.15,.2],min_max:[1.2,.9]}]],["2H",[.2,.4,.3,2,60,.2,{curve:[.15,.2],min_max:[1.2,.9]}]],["cpencil",[.4,.55,.8,7,70,.15,{curve:[.15,.2],min_max:[.95,1.2]}]],["charcoal",[.35,1.5,.65,300,60,.06,{curve:[.15,.2],min_max:[1.3,.9]}]],["crayon",[.25,2,.8,300,60,.06,{curve:[.35,.2],min_max:[.9,1.1]}]],["spray",[.2,12,15,40,35,.65,{curve:[0,.1],min_max:[1,1]},"spray"]],["marker",[2.5,.12,null,null,.4,.04,{curve:[.35,.25],min_max:[1.5,1]},"marker"]]];for(let t of ge){let e={};for(let i=0;i<t[1].length;i++)e[me[i]]=t[1][i];Vt(t[0],e)}function xe(){return{...B.hatch}}function de(t=5,e=45,i={rand:!1,continuous:!1,gradient:!1}){let n=B.hatch;n.isActive=!0,n.dist=t,n.angle=e,n.options=i}function pe(t){let e=B.hatch.dist,i=w(B.hatch.angle)%180,n=B.hatch.options,r=Zt();B.hatch.hBrush&&Qt(...Object.values(B.hatch.hBrush)),Array.isArray(t)||(t=[t]);const o=function(t){let e={minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};for(let i of t){const t=ye(i);e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}return e}(t);let s=new at([[o.minX,o.minY],[o.maxX,o.minY],[o.maxX,o.maxY],[o.minX,o.maxY]]),a=i<=90&&i>=0?o.minY:o.maxY,c=n.gradient?x(n.gradient,0,1,1,1.1,!0):1,l=[],u=0,f=e,m=t=>({point1:{x:o.minX+f*t*R(90-i),y:a+f*t*E(90-i)},point2:{x:o.minX+f*t*R(90-i)+R(-i),y:a+f*t*E(90-i)+E(-i)}});for(;s.intersect(m(u)).length>0;){let e=[];for(let i of t)e.push(i.intersect(m(u)));l[u]=e.flat().sort(((t,e)=>t.x===e.x?t.y-e.y:t.x-e.x)),f*=c,u++}let g=l.filter((t=>void 0!==t[0])),d=n.rand||0;for(let t=0;t<g.length;t++){let i=g[t],r=t>0&&n.continuous;for(let n=0;n<i.length-1;n+=2)0!==d&&(i[n].x+=d*e*h(-10,10),i[n].y+=d*e*h(-10,10),i[n+1].x+=d*e*h(-10,10),i[n+1].y+=d*e*h(-10,10)),fe(i[n].x,i[n].y,i[n+1].x,i[n+1].y),r&&fe(g[t-1][1].x,g[t-1][1].y,i[n].x,i[n].y)}jt(r)}function ye(t){if(t._boundingBox)return t._boundingBox;let e=Infinity,i=Infinity,n=-Infinity,r=-Infinity;for(let o=0;o<t.a.length;o++){const[s,a]=t.a[o];s<e&&(e=s),s>n&&(n=s),a<i&&(i=a),a>r&&(r=a)}return t._boundingBox={minX:e,minY:i,maxX:n,maxY:r},t._boundingBox}function _e(){return{...B.fill}}function ve(t,e,i,n){B.fill.opacity=(arguments.length<4?e:n)||60,B.fill.color=arguments.length<3?new X(t):new X(t,e,i),B.fill.isActive=!0}function be(t,e="out"){B.fill.bleed_strength=d(t,0,1),B.fill.direction=e}function Re(t=.4,e=.4){B.fill.texture_strength=d(t,0,1),B.fill.border_strength=d(e,0,1)}let Ee;at.prototype.draw=function(t=!1,e,i){let n=Zt();if(t&&Qt(t,e,i),n.isActive)for(let t of this.sides)fe(t[0].x,t[0].y,t[1].x,t[1].y);jt(n)},ct.prototype.draw=function(t,e,i){Zt().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),function(t,e,i,n){q(),ee(e,i,t.length,!0,t),ne(n,!0)}(this,t,e,i))},B.hatch={isActive:!1,dist:5,angle:45,options:{},hBrush:!1},at.prototype.hatch=function(t=!1,e,i){let n=xe();t&&de(t,e,i),n.isActive&&pe(this),function(t){B.hatch={...t}}(n)},ct.prototype.hatch=function(t,e,i){xe().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),this.pol=this.genPol(t,e,i,.25),this.pol.hatch())},B.fill={color:new X("#002185"),opacity:60,bleed_strength:.07,texture_strength:.8,border_strength:.5,direction:"out",isActive:!1};const we=[],Se=[];class Ae{constructor(t,e,i,n,r,o,s){if(this.v=t,this.dir=n,this.m=e,this.sizeX=o,this.sizeY=s,this.midP=i,r){this.sizeX=-Infinity,this.sizeY=-Infinity;for(let t of this.v)this.sizeX=Math.max(Math.abs(this.midP.x-t.x),this.sizeX),this.sizeY=Math.max(Math.abs(this.midP.y-t.y),this.sizeY);for(let t=0;t<this.v.length;t++){const e=this.v[t],i=this.v[(t+1)%this.v.length],n={x:i.x-e.x,y:i.y-e.y},r=S(0,0,n.x,n.y,90);let o={point1:{x:e.x+n.x/2,y:e.y+n.y/2},point2:{x:e.x+n.x/2+r.x,y:e.y+n.y/2+r.y}};const s=(t,e,i)=>(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)>.01;let a=0;for(let t of Ee.intersect(o))s(e,i,t)&&a++;this.dir[t]=a%2==0}this.midP={x:i.x+this.sizeX*h(-.3,.3),y:i.y+this.sizeY*h(-.3,.3)}}}trim(t=1){let e=[...this.v],i=[...this.m],n=[...this.dir];if(this.v.length>8&&t>=0&&1!==t){const r=~~((1-t)*this.v.length),o=~~(this.v.length/2-r/2);e.splice(o,r),i.splice(o,r),n.splice(o,r)}return{v:e,m:i,dir:n}}grow(t=1){const{v:e,m:i,dir:n}=this.trim(t),r=e.length,o=2*r,s=new Array(o),a=new Array(o),c=new Array(o),l="out"===B.fill.direction?-90:90;let f=0,g=999===t?h(.2,.6):B.fill.bleed_strength/1.7;for(let o=0;o<r;o++){we.length<1.5*r&&(we.push(m(.5,.2)),Se.push(m(0,.02)));const x=e[o],d=o+1<r?e[o+1]:e[0];t<997&&(g=et.get(x.x,x.y,i[o]));const p=(n[o]?l:-l)+5*h(-1,1),y=d.x-x.x,_=d.y-x.y,{x:v,y:b}=S(0,0,y,_,p),R=h(.35,.65),E=u(we)*h(.65,1.35)*g;s[f]=x,a[f]=i[o],c[f++]=n[o],s[f]={x:x.x+y*R+v*E,y:x.y+_*R+b*E},a[f]=i[o]+u(Se),c[f++]=n[o]}return new Ae(s,a,this.midP,c,!1,this.sizeX,this.sizeY)}fill(t,e,i){const n=3*i,r=e*(1+i/2);U.blend(t),U.ctx.save(),U.ctx.fillStyle="rgb(255 0 0 / "+2*r+"%)",U.ctx.strokeStyle="rgb(255 0 0 / "+.01*B.fill.border_strength+")";const o=Math.max(this.sizeX,this.sizeY);U.ctx.lineCap="round";const s=h(.15,.7);let a,c=this.grow();for(let i=0;i<24;i++){i%4==0&&(c=c.grow()),a=[c.grow(1-.0125*i),c.grow(.7-.0125*i),c.grow(.4-.0125*i)];for(let t of a)t.grow(997).grow().layer(i,o);c.grow(s).grow(999).layer(i,o),i%6!=0&&23!==i||(0!==n&&c.erase(4*n,e),U.blend(t,!0,!1,!0))}et.update(),U.ctx.restore()}layer(t,e){U.ctx.lineWidth=x(t,0,24,e/25,e/30,!0),nt(this.v),U.ctx.fill(),U.ctx.stroke()}erase(t,e){U.ctx.save();let i=h(60,80)*x(t,0,1,2,3.5);const n=this.sizeX/1.7,r=this.sizeY/1.7,o=Math.min(this.sizeX,this.sizeY)*(1.4-B.fill.bleed_strength),s=.05*o,a=.4*o,c=this.midP.x,l=this.midP.y;U.ctx.globalCompositeOperation="destination-out";let u=(5-x(e,80,100,.3,1,!0))*t;U.ctx.fillStyle="rgb(255 0 0 / "+u/255+")",U.ctx.lineWidth=0;for(let t=0;t<i;t++){const e=c+m(0,n),i=l+m(0,r),o=h(s,a);U.ctx.beginPath(),rt(e,i,o),t%4!=0&&U.ctx.fill()}U.ctx.globalCompositeOperation="source-over",U.ctx.restore()}}at.prototype.fill=function(t=!1,e,i,n,r,o){let s=_e();t&&(ve(t,e),be(i,o),Re(n,r)),s.isActive&&(q(),function(t){Ee=t;let e=[...t.vertices];const i=e.length,n=.25*i*g({1:5,2:10,3:60}),r=B.fill.bleed_strength;let o=e.map(((t,e)=>{let i=h(.85,1.2)*r;return e>n?i:.2*i}));const s=f(0,i);e=[...e.slice(s),...e.slice(0,s)];const a=function(t){const e=(t=[...t])[0],i=t[t.length-1];e.x===i.x&&e.y===i.y||t.push(e);let n=0,r=0,o=0,s=t.length;for(let i=0,a=s-1;i<s;a=i++){const s=t[i],c=t[a],l=(s.y-e.y)*(c.x-e.x)-(c.y-e.y)*(s.x-e.x);n+=l,r+=(s.x+c.x-2*e.x)*l,o+=(s.y+c.y-2*e.y)*l}const a=3*n;return{x:r/a+e.x,y:o/a+e.y}}(e);new Ae(e,o,a,[],!0).fill(B.fill.color,x(B.fill.opacity,0,100,0,1,!0),B.fill.texture_strength)}(this)),function(t){B.fill={...t}}(s)},ct.prototype.fill=function(t,e,i){_e().isActive&&(this.origin&&(t=this.origin[0],e=this.origin[1],i=1),this.pol=this.genPol(t,e,i,x(B.fill.bleed_strength,0,.6,.3,.45,!0)),this.pol.fill())},t.Color=X,t.Plot=ct,t.Polygon=at,t.Position=H,t.add=Vt,t.addField=tt,t.arc=function(t,e,i,n,r){const o=new ct("curve"),s=270-w(n),a=270-w(r),c=w(r-n),l=Math.PI*i*c/180;o.addSegment(s,l,1,!0),o.endPlot(a,1,!0);const h=t+i*R(-s-90),u=e+i*E(-s-90);o.draw(h,u,1)},t.background=function(t,e,i){Y(),D=new X(...arguments),U.worker.postMessage({color:D.gl,isBG:!0})},t.beginPath=xt,t.beginStroke=function(t,e,i){mt=[e,i],ft=new ct(t)},t.box=function(){return[...Ht.keys()]},t.circle=function(t,e,i,n=!1){const r=new ct("curve"),o=Math.PI*i,s=h(0,360),a=n?()=>1+.2*h():()=>1;for(let t=0;t<4;t++){const e=-90*t+s;r.addSegment(e*a(),o/2*a(),1,!0)}if(n){const t=f(-5,5);r.addSegment(s,Math.abs(t)*(Math.PI/180)*i,1,!0),r.endPlot(t+s,1,!0)}else r.endPlot(s,1,!0);const c=t-i*E(s),l=e-i*R(-s);r.show(c,l,1)},t.clip=function(t){B.stroke.clipWindow=t},t.closePath=yt,t.draw=Pt,t.drawImage=function(t,e=0,i=0,n=t.width,r=t.height){Y(),"[object ImageBitmap]"===Object.prototype.toString.call(t)&&0===e||(U.ctx.drawImage(t,e,i,n,r),t=U.mask.transferToImageBitmap()),U.blend(!1,!1,t)},t.endPath=_t,t.endStroke=function(t,e){ft.endPlot(t,e),ft.draw(mt[0],mt[1],1),ft=!1},t.erase=function(t=_bg_Color,e=255){ot.isActive=!0,ot.c=new X(t),ot.a=e},t.field=function(t){if(!J.has(t))throw new Error(`Field "${name}" does not exist.`);B.field.isActive=!0,B.field.current=t},t.fillBleed=be,t.fillStyle=ve,t.fillTexture=Re,t.frameRate=St,t.hatch=de,t.hatchArray=pe,t.hatchStyle=function(t,e="black",i=1){B.hatch.hBrush={brush:t,color:e,weight:i}},t.line=fe,t.lineTo=pt,t.lineWidth=Jt,t.listFields=function(){return Array.from(J.keys())},t.load=function(t,e){L=t,k[L]||(k[L]={canvas:e}),M=k[L].canvas.width,F=k[L].canvas.height,z=!0,U.load()},t.loop=function(t=!1){t&&(bt=t),Et=!0,requestAnimationFrame(At)},t.move=function(t,e,i){ft.addSegment(t,e,i)},t.moveTo=dt,t.noClip=function(){B.stroke.clipWindow=null},t.noErase=function(){ot.isActive=!1},t.noField=function(){B.field.isActive=!1},t.noFill=function(){B.fill.isActive=!1},t.noHatch=function(){B.hatch.isActive=!1,B.hatch.hBrush=!1},t.noLoop=function(){Et=!1},t.noStroke=function(){B.stroke.isActive=!1},t.noiseSeed=function(e){t.noise=s(a(e))},t.pick=Kt,t.polygon=function(t){new at(t).show()},t.random=function(t=0,e=1){return Array.isArray(t)?u(t):1===arguments.length?l()*t:h(...arguments)},t.rect=function(t,e,i,n,r="corner"){"center"===r&&(t-=i/2,e-=n/2),xt(0),dt(t,e),pt(t+i,e),pt(t+i,e+n),pt(t,e+n),yt(),_t()},t.refreshField=function(t=0){J.get(B.field.current).field=J.get(B.field.current).gen(t,Q())},t.restore=function(){U.ctx.restore();let t=U.ctx.getTransform();W.x=t.e,W.y=t.f,B.stroke={...it.stroke},B.field={...it.field},B.hatch={...it.hatch},B.fill={...it.fill},et.restore()},t.rotate=function(t=0){q(),U.ctx.rotate(t)},t.save=function(){q(),U.ctx.save(),it.fill={...B.fill},it.stroke={...B.stroke},it.hatch={...B.hatch},it.field={...B.field},et.save()},t.scale=function(t){q(),U.ctx.scale(t,t)},t.scaleBrushes=function(t){for(const{param:e}of Ht.values())e&&(e.weight*=t,e.vibration*=t,e.spacing*=t)},t.seed=function(t){l=a(t)},t.set=Qt,t.spline=function(t,e=.5){vt(t,e).draw()},t.stroke=function(t,e,i,n){q(),ee(t,e,i,!0,!1),ne(w(n),!1)},t.strokeStyle=$t,t.translate=function(t,e){q(),U.ctx.translate(t,e);let i=U.ctx.getTransform();W.x=i.e,W.y=i.f},t.wRand=g},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).brush={});
//# sourceMappingURL=brush.js.map
